# ==============================================================================
# Canary Policy Simulation Plan - Canary 策略影響測試計畫
# ==============================================================================
# 用途: 在 canary 小環境測試 policy 變更的影響
# 語言: 繁體中文
# ==============================================================================

canaryPlan:
  name: policy-change-canary-test
  version: 1.0.0
  description: 在 canary 環境測試策略變更對現有資源的影響
  
  # 測試環境
  environment:
    name: canary
    namespace: canary-test
    cluster: staging-cluster
    duration: 2h
    
  # Canary 配置
  canary:
    # 流量分配
    traffic_split:
      stable: 90%
      canary: 10%
    
    # 漸進式推進
    progressive_rollout:
      enabled: true
      steps:
        - percentage: 10
          duration: 15m
          success_criteria:
            error_rate: <1%
            latency_p95: <500ms
        
        - percentage: 25
          duration: 30m
          success_criteria:
            error_rate: <0.5%
            latency_p95: <400ms
        
        - percentage: 50
          duration: 45m
          success_criteria:
            error_rate: <0.1%
            latency_p95: <300ms
        
        - percentage: 100
          duration: 30m
          success_criteria:
            error_rate: <0.1%
            latency_p95: <250ms
    
    # 自動回滾
    auto_rollback:
      enabled: true
      conditions:
        - metric: error_rate
          threshold: ">2%"
          duration: 5m
        
        - metric: latency_p95
          threshold: ">1s"
          duration: 10m
        
        - metric: policy_violations
          threshold: ">5"
          duration: 1m
  
  # 策略變更測試
  policyChanges:
    # 新策略檔案
    new_policies:
      - path: intelligent-hyperautomation/policies/rego/uav_ad.rego
        version: v2.1.0
        changes:
          - type: rule_addition
            rule: require_network_policy
            severity: high
          
          - type: rule_modification
            rule: resource_limits
            old_value: "512Mi"
            new_value: "256Mi"
            severity: medium
    
    # 受影響資源
    affected_resources:
      - kind: Deployment
        namespace: "*"
        labels:
          uav.io/system: "uav"
        estimated_count: 15
      
      - kind: Service
        namespace: "*"
        labels:
          uav.io/system: "uav"
        estimated_count: 8
    
    # 測試場景
    test_scenarios:
      # 場景 1: 現有資源驗證
      - name: existing_resources_compliance
        description: 驗證現有資源是否符合新策略
        type: validation
        steps:
          - name: collect_resources
            command: kubectl get deployment,service -A -l uav.io/system=uav -o yaml
          
          - name: validate_against_new_policy
            command: conftest test resources.yaml -p new-policies/
          
          - name: analyze_violations
            expected_violations: <=5
            action_on_exceed: generate_report
      
      # 場景 2: 新資源部署
      - name: new_resource_deployment
        description: 測試新資源能否通過策略驗證
        type: deployment
        steps:
          - name: deploy_test_resource
            manifest: canary/test-deployment.yaml
          
          - name: validate_admission
            expected: allow
          
          - name: monitor_runtime
            duration: 10m
            metrics:
              - policy_violations
              - admission_errors
      
      # 場景 3: 策略修復影響
      - name: policy_fix_impact
        description: 測試修復策略違規的影響
        type: remediation
        steps:
          - name: identify_violations
            command: conftest test --fail-on-warn
          
          - name: apply_fixes
            auto_fix: true
            dry_run: true
          
          - name: measure_impact
            metrics:
              - resources_modified
              - breaking_changes
              - rollback_required
  
  # 影響度計算
  impact_analysis:
    enabled: true
    
    # 量化指標
    metrics:
      # 違規風險
      violation_risk:
        weight: 0.4
        calculation: (new_violations / total_resources) * 100
        acceptable_threshold: <10%
      
      # 回滾成本
      rollback_cost:
        weight: 0.3
        factors:
          - resource_count
          - dependency_complexity
          - downtime_minutes
        acceptable_threshold: <high
      
      # 修復複雜度
      fix_complexity:
        weight: 0.2
        factors:
          - manual_fixes_required
          - automated_fixes_available
          - testing_effort
        acceptable_threshold: <medium
      
      # 業務影響
      business_impact:
        weight: 0.1
        factors:
          - service_disruption
          - user_impact
          - sla_breach_risk
        acceptable_threshold: <medium
    
    # 決策矩陣
    decision_matrix:
      - impact_score: 0-20
        recommendation: proceed
        approval_required: false
      
      - impact_score: 21-50
        recommendation: proceed_with_caution
        approval_required: true
        approvers: ["platform-team"]
      
      - impact_score: 51-80
        recommendation: phased_rollout
        approval_required: true
        approvers: ["platform-team", "sre-team"]
      
      - impact_score: 81-100
        recommendation: defer
        approval_required: true
        approvers: ["platform-team", "sre-team", "cto"]
  
  # 報告生成
  reporting:
    enabled: true
    
    # 報告內容
    include:
      - executive_summary
      - violation_details
      - impact_score
      - rollback_cost_estimate
      - remediation_plan
      - risk_assessment
      - recommendation
    
    # 輸出格式
    formats:
      - json
      - markdown
      - html
    
    # 報告位置
    output:
      path: reports/canary/
      filename: "policy-sim-{timestamp}.json"
    
    # 分發
    distribution:
      - type: slack
        channel: "#platform-decisions"
        on_severity: ["high", "critical"]
      
      - type: email
        recipients:
          - platform-team@example.com
        on_severity: ["critical"]
      
      - type: artifact
        storage: github-artifacts
        retention_days: 90
  
  # 驗收標準
  acceptance_criteria:
    - name: violation_rate
      threshold: <5%
      required: true
    
    - name: rollback_cost
      threshold: <medium
      required: true
    
    - name: business_impact
      threshold: <low
      required: true
    
    - name: approval_obtained
      required: true
      approvers_count: >=2
  
  # 後續行動
  post_actions:
    on_success:
      - action: promote_to_production
        wait_period: 24h
        notification: true
      
      - action: update_documentation
        paths:
          - docs/policy-changelog.md
          - intelligent-hyperautomation/CHANGELOG.md
    
    on_failure:
      - action: rollback
        immediate: true
      
      - action: create_incident_report
        assignees: ["platform-team"]
      
      - action: schedule_review
        participants: ["platform-team", "sre-team"]

# ==============================================================================
# 使用方式
# ==============================================================================
# 1. 觸發 canary 測試:
#    kubectl apply -f canary/policy-sim-plan.yaml
#
# 2. 監控測試進度:
#    kubectl logs -f -l app=canary-policy-tester
#
# 3. 查看影響報告:
#    cat reports/canary/policy-sim-latest.json | jq '.impact_analysis'
#
# 4. 決策:
#    基於報告的 recommendation 決定是否繼續推進
# ==============================================================================
