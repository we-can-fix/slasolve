# Vulnerability Detector Agent

## 概述

漏洞檢測代理 (Vulnerability Detector Agent) 專注於深度安全分析，識別代碼中的安全漏洞、依賴風險和配置問題。

## 功能特性

### 1. 安全漏洞檢測
- **OWASP Top 10**: 完整覆蓋常見 Web 安全漏洞
- **CWE 分類**: 按 CWE 標準分類漏洞
- **CVSS 評分**: 自動計算漏洞嚴重程度
- **零日漏洞**: 檢測未知的安全問題

### 2. 依賴分析
- **已知漏洞**: 檢測依賴項中的 CVE
- **許可證合規**: 驗證開源許可證
- **版本過時**: 檢測過時的依賴項
- **供應鏈風險**: 評估依賴鏈風險

### 3. 配置安全
- **密鑰洩漏**: 檢測硬編碼密鑰
- **不安全配置**: 識別不安全的配置
- **權限問題**: 檢測權限配置錯誤
- **網絡安全**: 分析網絡配置

## 支援的檢測類型

### A. 注入攻擊
- SQL 注入
- NoSQL 注入
- OS 命令注入
- LDAP 注入
- XPath 注入

### B. 認證與授權
- 弱密碼策略
- 會話管理問題
- 權限提升
- JWT 漏洞

### C. 敏感數據暴露
- 硬編碼密鑰
- 日誌中的敏感信息
- 不安全的數據傳輸
- 加密缺失

### D. 配置錯誤
- 默認配置
- 不安全的 CORS
- 錯誤的 TLS 配置
- 調試模式啟用

## 架構設計

```
vulnerability-detector/
├── src/
│   ├── detectors/
│   │   ├── injection_detector.py
│   │   ├── auth_detector.py
│   │   ├── crypto_detector.py
│   │   └── config_detector.py
│   ├── scanners/
│   │   ├── dependency_scanner.py
│   │   ├── container_scanner.py
│   │   └── network_scanner.py
│   ├── analyzers/
│   │   ├── threat_analyzer.py
│   │   └── risk_analyzer.py
│   └── engine.py
├── config/
│   ├── detector.yaml
│   ├── rules/
│   └── signatures/
├── tests/
└── README.md
```

## 使用方式

### 基本用法

```python
from vulnerability_detector import VulnerabilityDetector

# 初始化檢測器
detector = VulnerabilityDetector(config_path="config/detector.yaml")

# 掃描代碼
vulnerabilities = await detector.scan_code(
    file_path="src/app.py",
    scan_type="full"
)

# 掃描依賴項
dep_vulns = await detector.scan_dependencies(
    manifest="package.json"
)

# 輸出結果
for vuln in vulnerabilities:
    print(f"{vuln.severity}: {vuln.title}")
    print(f"  CWE: {vuln.cwe_id}")
    print(f"  CVSS: {vuln.cvss_score}")
```

### 配置範例

```yaml
# detector.yaml
enabled: true
scan_depth: deep

detectors:
  injection:
    enabled: true
    types: ["sql", "xss", "cmd"]
  
  secrets:
    enabled: true
    entropy_threshold: 4.5
    patterns:
      - "api[_-]?key"
      - "password"
      - "secret"
  
  dependencies:
    enabled: true
    sources: ["snyk", "nvd", "osv"]
    severity_threshold: "MEDIUM"
```

## 輸出格式

### 漏洞報告

```json
{
  "scan_id": "vuln-scan-123",
  "timestamp": "2025-11-25T14:47:00Z",
  "summary": {
    "total": 15,
    "critical": 2,
    "high": 5,
    "medium": 6,
    "low": 2
  },
  "vulnerabilities": [
    {
      "id": "VULN-001",
      "title": "SQL Injection in login endpoint",
      "severity": "CRITICAL",
      "cvss_score": 9.8,
      "cwe_id": "CWE-89",
      "location": {
        "file": "src/auth.py",
        "line": 45
      },
      "description": "User input is directly concatenated into SQL query",
      "impact": "Complete database compromise",
      "remediation": "Use parameterized queries",
      "references": [
        "https://owasp.org/www-community/attacks/SQL_Injection"
      ]
    }
  ]
}
```

## 整合工具

### 1. Semgrep
```yaml
# .semgrep.yml
rules:
  - id: hardcoded-secret
    pattern: password = "..."
    message: Hardcoded password detected
    severity: ERROR
```

### 2. Snyk
```bash
# 掃描依賴項
snyk test --json > snyk-results.json

# 掃描容器
snyk container test myapp:latest
```

### 3. Trivy
```bash
# 掃描文件系統
trivy fs --security-checks vuln,config .

# 掃描 IaC
trivy config --severity HIGH,CRITICAL .
```

## 風險評估

### CVSS 3.1 評分標準

```python
def calculate_cvss_score(vulnerability):
    """
    計算 CVSS 3.1 分數
    
    基礎指標：
    - Attack Vector (AV): Network/Adjacent/Local/Physical
    - Attack Complexity (AC): Low/High
    - Privileges Required (PR): None/Low/High
    - User Interaction (UI): None/Required
    - Scope (S): Unchanged/Changed
    - Confidentiality (C): None/Low/High
    - Integrity (I): None/Low/High
    - Availability (A): None/Low/High
    """
    base_score = calculate_base_score(
        av=vulnerability.attack_vector,
        ac=vulnerability.attack_complexity,
        pr=vulnerability.privileges_required,
        ui=vulnerability.user_interaction,
        s=vulnerability.scope,
        c=vulnerability.confidentiality_impact,
        i=vulnerability.integrity_impact,
        a=vulnerability.availability_impact
    )
    
    return base_score
```

## 威脅建模

### STRIDE 威脅分類

- **S**poofing (身份欺騙)
- **T**ampering (篡改)
- **R**epudiation (否認)
- **I**nformation Disclosure (信息洩露)
- **D**enial of Service (拒絕服務)
- **E**levation of Privilege (權限提升)

## CI/CD 整合

```yaml
# .github/workflows/security-scan.yml
name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: '0 0 * * *'  # 每日掃描

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Vulnerability Detector
        run: |
          python agent/vulnerability-detector/src/engine.py \
            --scan-type full \
            --output security-report.json
      
      - name: Check for Critical Issues
        run: |
          critical_count=$(jq '.summary.critical' security-report.json)
          if [ "$critical_count" -gt 0 ]; then
            echo "Found $critical_count critical vulnerabilities!"
            exit 1
          fi
```

## 修復優先級

### 優先級矩陣

| 嚴重程度 | 可利用性 | 優先級 | SLA |
|---------|---------|--------|-----|
| Critical | High | P0 | 4h |
| Critical | Medium | P1 | 24h |
| High | High | P1 | 24h |
| High | Medium | P2 | 72h |
| Medium | Any | P3 | 1w |
| Low | Any | P4 | 1m |

## 報告生成

### HTML 報告
```bash
# 生成 HTML 報告
python src/engine.py --format html --output report.html
```

### PDF 報告
```bash
# 生成 PDF 報告
python src/engine.py --format pdf --output report.pdf
```

### SARIF 格式
```json
{
  "version": "2.1.0",
  "runs": [{
    "tool": {
      "driver": {
        "name": "SLASolve Vulnerability Detector"
      }
    },
    "results": []
  }]
}
```

## 最佳實務

### 1. 定期掃描
- 每次代碼提交自動掃描
- 每日完整掃描
- 每週深度掃描

### 2. 漏洞管理
- 建立漏洞數據庫
- 追蹤修復進度
- 定期複查

### 3. 持續改進
- 更新檢測規則
- 學習新的攻擊模式
- 優化誤報率

## 性能指標

- **掃描速度**: 500-2000 行代碼/秒
- **準確率**: > 98%
- **誤報率**: < 2%
- **漏報率**: < 1%

## 授權

MIT License
