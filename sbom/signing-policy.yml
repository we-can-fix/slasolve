# ==============================================================================
# SBOM ç°½ç« ç­–ç•¥
# ==============================================================================
# ç”¨é€”: è‡ªå‹•ç”¢å‡ºä¸¦ç°½ç«  SBOMï¼Œç¢ºä¿ä¾›æ‡‰éˆå¯è¿½æº¯
# èªè¨€: ç¹é«”ä¸­æ–‡
# ==============================================================================

name: SBOM Generation and Signing

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  release:
    types: [published]
  workflow_dispatch:

env:
  SBOM_FORMAT: cyclonedx-json
  SBOM_VERSION: '1.5'
  COSIGN_EXPERIMENTAL: 1

jobs:
  generate-sbom:
    name: ç”Ÿæˆèˆ‡ç°½ç«  SBOM
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      packages: write
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ å®‰è£ Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft version
      
      - name: ğŸ”§ å®‰è£ Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.1'
      
      - name: ğŸ“¦ ç”Ÿæˆ SBOM - å°ˆæ¡ˆæ ¹ç›®éŒ„
        run: |
          echo "ğŸ” æƒæå°ˆæ¡ˆä¾è³´..."
          syft packages dir:. \
            -o cyclonedx-json \
            --file sbom/project-sbom.json
          
          echo "âœ… SBOM å·²ç”Ÿæˆ: sbom/project-sbom.json"
          
          # ç”Ÿæˆäººé¡å¯è®€ç‰ˆæœ¬
          syft packages dir:. \
            -o table \
            --file sbom/project-sbom.txt
      
      - name: ğŸ“¦ ç”Ÿæˆ SBOM - Intelligent Hyperautomation
        run: |
          if [ -d "intelligent-hyperautomation" ]; then
            echo "ğŸ” æƒæ intelligent-hyperautomation..."
            syft packages dir:intelligent-hyperautomation \
              -o cyclonedx-json \
              --file sbom/intelligent-hyperautomation-sbom.json
            
            # æ›´æ–°ä½”ä½ç¬¦
            cp sbom/intelligent-hyperautomation-sbom.json \
               intelligent-hyperautomation/docs/sbom-placeholder.json
            
            echo "âœ… Intelligent Hyperautomation SBOM å·²ç”Ÿæˆ"
          fi
      
      - name: ğŸ“¦ ç”Ÿæˆ SBOM - Contracts L1
        run: |
          if [ -d "core/contracts/contracts-L1" ]; then
            echo "ğŸ” æƒæ Contracts L1..."
            syft packages dir:core/contracts/contracts-L1 \
              -o cyclonedx-json \
              --file sbom/contracts-l1-sbom.json
            
            echo "âœ… Contracts L1 SBOM å·²ç”Ÿæˆ"
          fi
      
      - name: ğŸ” ç°½ç«  SBOM - Keyless (Sigstore)
        run: |
          echo "ğŸ”‘ ä½¿ç”¨ Sigstore é€²è¡Œ keyless ç°½ç« ..."
          
          # ç°½ç« å°ˆæ¡ˆ SBOM
          if [ -f "sbom/project-sbom.json" ]; then
            cosign sign-blob \
              --yes \
              --output-signature sbom/project-sbom.sig \
              --output-certificate sbom/project-sbom.pem \
              sbom/project-sbom.json
            
            echo "âœ… å°ˆæ¡ˆ SBOM å·²ç°½ç« "
          fi
          
          # ç°½ç«  Intelligent Hyperautomation SBOM
          if [ -f "sbom/intelligent-hyperautomation-sbom.json" ]; then
            cosign sign-blob \
              --yes \
              --output-signature sbom/intelligent-hyperautomation-sbom.sig \
              --output-certificate sbom/intelligent-hyperautomation-sbom.pem \
              sbom/intelligent-hyperautomation-sbom.json
            
            echo "âœ… Intelligent Hyperautomation SBOM å·²ç°½ç« "
          fi
      
      - name: ğŸ“Š ç”Ÿæˆ SBOM æ‘˜è¦å ±å‘Š
        run: |
          cat > sbom/sbom-summary.json << EOF
          {
            "generation_timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "workflow_run_id": "${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "repository": "${{ github.repository }}",
            "sbom_format": "${SBOM_FORMAT}",
            "sbom_version": "${SBOM_VERSION}",
            "signing_method": "cosign-keyless",
            "generated_sboms": [
              {
                "name": "project-sbom.json",
                "path": "sbom/project-sbom.json",
                "signature": "sbom/project-sbom.sig",
                "certificate": "sbom/project-sbom.pem"
              },
              {
                "name": "intelligent-hyperautomation-sbom.json",
                "path": "sbom/intelligent-hyperautomation-sbom.json",
                "signature": "sbom/intelligent-hyperautomation-sbom.sig",
                "certificate": "sbom/intelligent-hyperautomation-sbom.pem"
              }
            ],
            "verification": {
              "command": "cosign verify-blob --signature <sig> --certificate <pem> --certificate-identity-regexp '.*' --certificate-oidc-issuer-regexp '.*' <sbom>",
              "tool": "cosign >= v2.2.0"
            },
            "metadata": {
              "language": "zh-TW",
              "compliance": ["SLSA Level 2", "CycloneDX 1.5"]
            }
          }
          EOF
          
          echo "ğŸ“‹ SBOM æ‘˜è¦å ±å‘Šå·²ç”Ÿæˆ"
          cat sbom/sbom-summary.json | jq '.'
      
      - name: ğŸ“¤ ä¸Šå‚³ SBOM Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: |
            sbom/*.json
            sbom/*.sig
            sbom/*.pem
            sbom/*.txt
          retention-days: 365
      
      - name: ğŸ“ˆ ç”Ÿæˆæ‘˜è¦
        run: |
          echo "## ğŸ”’ SBOM ç”Ÿæˆèˆ‡ç°½ç« æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ ç”Ÿæˆçš„ SBOM" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for sbom in sbom/*.json; do
            if [ -f "$sbom" ]; then
              filename=$(basename "$sbom")
              size=$(ls -lh "$sbom" | awk '{print $5}')
              echo "- âœ… $filename ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” ç°½ç« é©—è­‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰ SBOM å·²ä½¿ç”¨ Sigstore keyless ç°½ç« " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é©—è­‰å‘½ä»¤:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify-blob \\" >> $GITHUB_STEP_SUMMARY
          echo "  --signature sbom/project-sbom.sig \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate sbom/project-sbom.pem \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-identity-regexp '.*' \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-oidc-issuer-regexp '.*' \\" >> $GITHUB_STEP_SUMMARY
          echo "  sbom/project-sbom.json" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Artifact è³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ Artifact åç¨±: \`sbom-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- â° ä¿ç•™æœŸé™: 365 å¤©" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

# ==============================================================================
# ä½¿ç”¨èªªæ˜
# ==============================================================================
# è§¸ç™¼æ¢ä»¶:
# 1. Push åˆ° main åˆ†æ”¯
# 2. å‰µå»ºç‰ˆæœ¬æ¨™ç±¤ (v*.*.*)
# 3. ç™¼å¸ƒ Release
# 4. æ‰‹å‹•è§¸ç™¼
#
# ç”¢å‡º:
# - project-sbom.json: å°ˆæ¡ˆå®Œæ•´ SBOM
# - intelligent-hyperautomation-sbom.json: IA æ¨¡çµ„ SBOM
# - *.sig: Cosign ç°½ç« æª”æ¡ˆ
# - *.pem: Cosign æ†‘è­‰æª”æ¡ˆ
# - sbom-summary.json: SBOM ç”Ÿæˆæ‘˜è¦å ±å‘Š
#
# é©—è­‰:
# cosign verify-blob --signature <sig> --certificate <pem> \
#   --certificate-identity-regexp '.*' \
#   --certificate-oidc-issuer-regexp '.*' <sbom>
# ==============================================================================
