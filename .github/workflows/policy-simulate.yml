# ==============================================================================
# Policy Simulation Workflow
# ==============================================================================
# ç”¨é€”: åœ¨ CI/CD å‰å° Kubernetes manifests é€²è¡Œç­–ç•¥æ¨¡æ“¬
# è¼¸å‡º: æ©Ÿå™¨å¯è®€çš„ç­–ç•¥æ¸¬è©¦å ±å‘Š
# èªè¨€: ç¹é«”ä¸­æ–‡è¨»è§£èˆ‡è¼¸å‡º
# ==============================================================================

name: Policy Simulation

on:
  pull_request:
    paths:
      - 'core/contracts/contracts-L1/contracts/deploy/k8s/**'
      - 'core/contracts/contracts-L1/contracts/policy/**'
  push:
    branches:
      - main
    paths:
      - 'core/contracts/contracts-L1/contracts/deploy/k8s/**'
  workflow_dispatch:

jobs:
  policy-simulation:
    name: ç­–ç•¥æ¨¡æ“¬èˆ‡é©—è­‰
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: å®‰è£ OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/
          opa version
      
      - name: é©—è­‰ OPA ç­–ç•¥èªæ³•
        run: |
          echo "ğŸ“‹ é©—è­‰ OPA ç­–ç•¥æª”æ¡ˆèªæ³•..."
          opa check core/contracts/contracts-L1/contracts/policy/manifest-policies.rego
          echo "âœ… ç­–ç•¥èªæ³•é©—è­‰é€šé"
      
      - name: åŸ·è¡Œç­–ç•¥æ¨¡æ“¬ - Deployment
        id: sim-deployment
        continue-on-error: true
        run: |
          echo "ğŸ” æ¨¡æ“¬ Deployment ç­–ç•¥..."
          opa eval \
            --data core/contracts/contracts-L1/contracts/policy/manifest-policies.rego \
            --input core/contracts/contracts-L1/contracts/deploy/k8s/deployment-production.yaml \
            --format pretty \
            'data.kubernetes.deny' > deployment-report.txt
          
          opa eval \
            --data core/contracts/contracts-L1/contracts/policy/manifest-policies.rego \
            --input core/contracts/contracts-L1/contracts/deploy/k8s/deployment-production.yaml \
            --format json \
            'data.kubernetes.deny' > deployment-report.json
          
          cat deployment-report.txt
      
      - name: åŸ·è¡Œç­–ç•¥æ¨¡æ“¬ - Service
        id: sim-service
        continue-on-error: true
        run: |
          echo "ğŸ” æ¨¡æ“¬ Service ç­–ç•¥..."
          opa eval \
            --data core/contracts/contracts-L1/contracts/policy/manifest-policies.rego \
            --input core/contracts/contracts-L1/contracts/deploy/k8s/service-production.yaml \
            --format json \
            'data.kubernetes.deny' > service-report.json
      
      - name: åŸ·è¡Œç­–ç•¥æ¨¡æ“¬ - Ingress
        id: sim-ingress
        continue-on-error: true
        run: |
          echo "ğŸ” æ¨¡æ“¬ Ingress ç­–ç•¥..."
          opa eval \
            --data core/contracts/contracts-L1/contracts/policy/manifest-policies.rego \
            --input core/contracts/contracts-L1/contracts/deploy/k8s/ingress.yaml \
            --format json \
            'data.kubernetes.deny' > ingress-report.json
      
      - name: ç”Ÿæˆç­–ç•¥å ±å‘Š
        run: |
          cat > policy-report.json << 'EOF'
          {
            "simulation_timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "workflow_run_id": "${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}",
            "results": {
              "deployment": $(cat deployment-report.json 2>/dev/null || echo '{"result": []}'),
              "service": $(cat service-report.json 2>/dev/null || echo '{"result": []}'),
              "ingress": $(cat ingress-report.json 2>/dev/null || echo '{"result": []}')
            },
            "summary": {
              "total_checks": 3,
              "passed": 0,
              "failed": 0
            }
          }
          EOF
          
          echo "ğŸ“Š ç­–ç•¥æ¨¡æ“¬å ±å‘Šå·²ç”Ÿæˆ"
          cat policy-report.json | jq '.'
      
      - name: ä¸Šå‚³ç­–ç•¥å ±å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: policy-simulation-report
          path: |
            policy-report.json
            deployment-report.json
            service-report.json
            ingress-report.json
          retention-days: 30
      
      - name: è©•ä¼°çµæœ
        run: |
          echo "ğŸ¯ ç­–ç•¥æ¨¡æ“¬å®Œæˆ"
          echo "ğŸ“‹ å ±å‘Šå·²ä¸Šå‚³ç‚º artifact: policy-simulation-report"
          
          # æª¢æŸ¥æ˜¯å¦æœ‰ç­–ç•¥é•è¦
          DENY_COUNT=$(cat deployment-report.json | jq '.result[0].expressions[0].value | length' 2>/dev/null || echo "0")
          
          if [ "$DENY_COUNT" != "0" ] && [ "$DENY_COUNT" != "null" ]; then
            echo "âš ï¸ ç™¼ç¾ $DENY_COUNT å€‹ç­–ç•¥é•è¦"
            echo "è©³æƒ…è«‹æŸ¥çœ‹ artifact ä¸­çš„å ±å‘Š"
            exit 1
          else
            echo "âœ… æ‰€æœ‰ç­–ç•¥æª¢æŸ¥é€šé"
          fi

# ==============================================================================
# Workflow èªªæ˜
# ==============================================================================
# è§¸ç™¼æ¢ä»¶:
# 1. PR ä¿®æ”¹ K8s manifests æˆ– policy æª”æ¡ˆ
# 2. Push åˆ° main branch
# 3. æ‰‹å‹•è§¸ç™¼
#
# åŸ·è¡Œæ­¥é©Ÿ:
# 1. å®‰è£ OPA
# 2. é©—è­‰ç­–ç•¥èªæ³•
# 3. å°æ¯å€‹ manifest åŸ·è¡Œç­–ç•¥æ¨¡æ“¬
# 4. ç”Ÿæˆæ©Ÿå™¨å¯è®€å ±å‘Š (JSON)
# 5. ä¸Šå‚³å ±å‘Šç‚º artifact (ä¿ç•™ 30 å¤©)
# 6. è©•ä¼°çµæœä¸¦æ±ºå®šæ˜¯å¦é€šé
#
# è¼¸å‡º:
# - policy-report.json: å®Œæ•´ç­–ç•¥æ¨¡æ“¬å ±å‘Š
# - deployment-report.json: Deployment ç­–ç•¥çµæœ
# - service-report.json: Service ç­–ç•¥çµæœ
# - ingress-report.json: Ingress ç­–ç•¥çµæœ
# ==============================================================================
