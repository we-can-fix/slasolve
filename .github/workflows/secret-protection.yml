name: "Enterprise Secret Protection"

on:
  push:
    branches: ["main", "develop", "release/*"]
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch:

jobs:
  secret-scanning:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Check Repository Secret Scanning Status
      id: check-status
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Checking secret scanning status for repository..."
        
        # Check if secret scanning is enabled
        STATUS=$(gh api \
          /repos/${{ github.repository }} \
          --jq '.security_and_analysis.secret_scanning.status' || echo "not_configured")
        
        echo "Current secret scanning status: $STATUS"
        echo "status=$STATUS" >> $GITHUB_OUTPUT

    - name: Scan for Exposed Secrets
      run: |
        echo "üîç Scanning for exposed secrets in commit history..."
        
        # Define secret patterns
        declare -A PATTERNS=(
          ["GitHub Token"]="github_pat_[0-9A-Za-z]{36}"
          ["OpenAI API Key"]="sk-[0-9A-Za-z]{48}"
          ["AWS Access Key"]="AKIA[0-9A-Z]{16}"
          ["Azure Client Secret"]="[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
          ["Generic API Key"]="api[_-]?key['\"]?[\s]*[:=][\s]*['\"]?[0-9a-zA-Z]{32,}"
          ["Private Key"]="-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----"
        )
        
        SECRETS_FOUND=0
        
        # Scan recent commits
        for commit in $(git log --oneline -10 --format="%H"); do
          echo "Checking commit: $commit"
          
          for pattern_name in "${!PATTERNS[@]}"; do
            pattern="${PATTERNS[$pattern_name]}"
            
            if git show "$commit" | grep -E "$pattern" > /dev/null 2>&1; then
              echo "‚ùå $pattern_name detected in commit $commit"
              SECRETS_FOUND=$((SECRETS_FOUND + 1))
            fi
          done
        done
        
        if [ $SECRETS_FOUND -gt 0 ]; then
          echo "‚ö†Ô∏è  $SECRETS_FOUND potential secrets found in commit history"
          echo "Please review and remediate immediately"
        else
          echo "‚úÖ No secrets detected in recent commits"
        fi

    - name: Scan Modified Files
      if: github.event_name == 'pull_request'
      run: |
        echo "üîç Scanning modified files in PR..."
        
        # Get list of modified files
        gh pr view ${{ github.event.pull_request.number }} \
          --json files --jq '.files[].path' > modified_files.txt
        
        SECRETS_IN_PR=0
        
        while read -r file; do
          if [ -f "$file" ]; then
            echo "Checking file: $file"
            
            # Check for common secret patterns
            if grep -iE "(password|secret|token|api_key|private_key)[\s]*[:=][\s]*['\"][^'\"]{8,}" "$file" > /dev/null 2>&1; then
              echo "‚ö†Ô∏è  Potential secret in $file"
              SECRETS_IN_PR=$((SECRETS_IN_PR + 1))
            fi
          fi
        done < modified_files.txt
        
        if [ $SECRETS_IN_PR -gt 0 ]; then
          echo "secrets_found=$SECRETS_IN_PR" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Comment on PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v8
      with:
        script: |
          const comment = `## üîê Secret Scanning Results
          
          ### Status: ${context.payload.pull_request ? '‚úÖ Scan completed' : '‚ö†Ô∏è Manual review required'}
          
          #### Recommendations:
          - Never commit secrets, tokens, or credentials
          - Use GitHub Secrets for sensitive data
          - Review the [Security Policy](${{ github.server_url }}/${{ github.repository }}/security/policy)
          - Enable push protection for all repositories
          
          #### What to do if you accidentally committed a secret:
          1. Rotate/revoke the secret immediately
          2. Remove it from git history using \`git filter-branch\` or BFG Repo-Cleaner
          3. Force push the cleaned history
          4. Update any systems using the old secret
          
          For more information, see our [Secret Scanning Guide](https://docs.github.com/en/code-security/secret-scanning).
          `;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Create Security Advisory
      if: failure()
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Creating security advisory for exposed secrets..."
        
        # Note: This would typically create a private security advisory
        # For demonstration, we're logging the recommendation
        echo "‚ö†Ô∏è  Secrets detected - immediate action required:"
        echo "1. Revoke all exposed credentials"
        echo "2. Update affected systems"
        echo "3. Review access logs for unauthorized usage"
        echo "4. Implement secret scanning across all repositories"
