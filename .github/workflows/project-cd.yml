---
name: å¯é‡ç”¨ CD Pipeline

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'å°ˆæ¡ˆå·¥ä½œç›®éŒ„'
        required: true
        type: string
      service-name:
        description: 'æœå‹™åç¨±'
        required: true
        type: string
      image-name:
        description: 'Docker æ˜ åƒåç¨±'
        required: false
        type: string
        default: ''
      registry:
        description: 'å®¹å™¨ç™»éŒ„ä½å€'
        required: false
        type: string
        default: 'ghcr.io'
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ (dev/staging/prod)'
        required: false
        type: string
        default: 'dev'
      enable-cosign:
        description: 'å•Ÿç”¨ Cosign ç°½ç« '
        required: false
        type: boolean
        default: true
      enable-sbom:
        description: 'å•Ÿç”¨ SBOM ç”Ÿæˆ'
        required: false
        type: boolean
        default: true
      enable-policy-check:
        description: 'å•Ÿç”¨æ”¿ç­–æª¢æŸ¥'
        required: false
        type: boolean
        default: true
      deploy-to-k8s:
        description: 'éƒ¨ç½²åˆ° Kubernetes'
        required: false
        type: boolean
        default: false
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false
      COSIGN_PRIVATE_KEY:
        required: false
      COSIGN_PASSWORD:
        required: false
      KUBECONFIG:
        required: false
    outputs:
      image-digest:
        description: 'æ˜ åƒ digest'
        value: ${{ jobs.build-and-push.outputs.image-digest }}
      image-tag:
        description: 'æ˜ åƒæ¨™ç±¤'
        value: ${{ jobs.build-and-push.outputs.image-tag }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write  # ç”¨æ–¼ Cosign keyless signing
      security-events: write
    
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
    
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      
      - name: ðŸ”§ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
      
      - name: ðŸ“ Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ inputs.registry }}/${{ github.repository_owner }}/${{ inputs.image-name || inputs.service-name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=${{ inputs.service-name }}
            org.opencontainers.image.description=SLASolve ${{ inputs.service-name }}
            namespace.io/team=contracts-team
            namespace.io/environment=${{ inputs.environment }}
            namespace.io/lifecycle=active
      
      - name: ðŸ” Login to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.REGISTRY_USERNAME || github.actor }}
          password: ${{ secrets.REGISTRY_PASSWORD || secrets.GITHUB_TOKEN }}
      
      - name: ðŸ—ï¸ Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.working-directory }}
          file: ${{ inputs.working-directory }}/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          provenance: true
          sbom: true
          build-args: |
            BUILD_SHA=${{ github.sha }}
            BUILD_VERSION=${{ github.ref_name }}
      
      - name: ðŸ“‹ Generate SBOM
        if: inputs.enable-sbom && github.event_name != 'pull_request'
        run: |
          echo "ðŸ” ç”Ÿæˆ SBOM..."
          # ä½¿ç”¨ syft ç”Ÿæˆ SBOM
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            anchore/syft:latest \
            ${{ steps.meta.outputs.tags }} \
            -o cyclonedx-json=sbom.json || echo "âš ï¸ SBOM ç”Ÿæˆå¤±æ•—ï¼ˆéžé˜»æ–·ï¼‰"
          
          if [ -f "sbom.json" ]; then
            echo "âœ… SBOM ç”ŸæˆæˆåŠŸ"
            ls -lh sbom.json
          fi
      
      - name: ðŸ” Install Cosign
        if: inputs.enable-cosign && github.event_name != 'pull_request'
        uses: sigstore/cosign-installer@v3
      
      - name: âœï¸ Sign image with Cosign
        if: inputs.enable-cosign && github.event_name != 'pull_request'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          if [ -n "${{ secrets.COSIGN_PRIVATE_KEY }}" ]; then
            echo "ðŸ” ä½¿ç”¨ç§é‘°ç°½ç« ..."
            echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
            cosign sign --key cosign.key \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.ref }}" \
              ${{ steps.meta.outputs.tags }}@${{ steps.build.outputs.digest }}
            rm -f cosign.key
          else
            echo "ðŸ”“ ä½¿ç”¨ keyless ç°½ç« ..."
            cosign sign \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.ref }}" \
              ${{ steps.meta.outputs.tags }}@${{ steps.build.outputs.digest }} || \
            echo "âš ï¸ Cosign ç°½ç« å¤±æ•—ï¼ˆéœ€é…ç½®å¯†é‘°æˆ– OIDCï¼‰"
          fi
      
      - name: ðŸ“¤ Upload SBOM artifact
        if: inputs.enable-sbom
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ inputs.service-name }}-${{ github.sha }}
          path: ${{ inputs.working-directory }}/sbom.json
          if-no-files-found: warn
          retention-days: 90
      
      - name: ðŸ“Š Build Summary
        run: |
          echo "## ðŸŽ¯ æ˜ åƒæ§‹å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æœå‹™åç¨± | ${{ inputs.service-name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ˜ åƒæ¨™ç±¤ | \`${{ steps.meta.outputs.tags }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM | ${{ inputs.enable-sbom && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cosign | ${{ inputs.enable-cosign && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
  
  policy-check:
    needs: build-and-push
    if: inputs.enable-policy-check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ðŸ“¥ Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ inputs.service-name }}-${{ github.sha }}
          path: ${{ inputs.working-directory }}
      
      - name: ðŸ” Install Conftest
        run: |
          wget -O conftest.tar.gz https://github.com/open-policy-agent/conftest/releases/download/v0.54.0/conftest_0.54.0_Linux_x86_64.tar.gz
          tar xzf conftest.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
          conftest --version
      
      - name: ðŸ” Policy check - Kubernetes manifests
        if: hashFiles(format('{0}/deploy/*.yaml', inputs.working-directory)) != ''
        run: |
          echo "ðŸ” æª¢æŸ¥ Kubernetes manifests..."
          if [ -d "../../.config/conftest/policies" ]; then
            conftest test deploy/*.yaml \
              --policy ../../.config/conftest/policies \
              --all-namespaces || echo "âš ï¸ æ”¿ç­–æª¢æŸ¥ç™¼ç¾å•é¡Œï¼ˆéžé˜»æ–·ï¼‰"
          else
            echo "â­ï¸ æœªæ‰¾åˆ°æ”¿ç­–æª”æ¡ˆï¼Œè·³éŽæª¢æŸ¥"
          fi
      
      - name: ðŸ“Š Policy Summary
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ æ”¿ç­–æª¢æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… æ”¿ç­–é©—è­‰å·²åŸ·è¡Œ" >> $GITHUB_STEP_SUMMARY
  
  deploy:
    needs: [build-and-push, policy-check]
    if: inputs.deploy-to-k8s && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ðŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.30.0'
      
      - name: ðŸ” Setup Kubeconfig
        if: secrets.KUBECONFIG != ''
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
      
      - name: ðŸš€ Deploy to Kubernetes
        if: secrets.KUBECONFIG != ''
        run: |
          echo "ðŸš€ éƒ¨ç½²åˆ° ${{ inputs.environment }} ç’°å¢ƒ..."
          cd ${{ inputs.working-directory }}/deploy
          
          # æ›´æ–°æ˜ åƒæ¨™ç±¤
          export IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
          
          # æ‡‰ç”¨ manifests
          kubectl apply -f rbac.yaml || echo "âš ï¸ RBAC æ‡‰ç”¨å¤±æ•—"
          kubectl apply -f service.yaml
          kubectl apply -f deployment.yaml
          kubectl apply -f hpa.yaml || echo "âš ï¸ HPA æ‡‰ç”¨å¤±æ•—"
          kubectl apply -f pdb.yaml || echo "âš ï¸ PDB æ‡‰ç”¨å¤±æ•—"
          kubectl apply -f networkpolicy.yaml || echo "âš ï¸ NetworkPolicy æ‡‰ç”¨å¤±æ•—"
          
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          
          # ç­‰å¾… rollout
          kubectl rollout status deployment/${{ inputs.service-name }} --timeout=5m || \
            echo "âš ï¸ Rollout ç‹€æ…‹æª¢æŸ¥é€¾æ™‚"
      
      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç’°å¢ƒ | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æœå‹™ | ${{ inputs.service-name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ˜ åƒ | ${{ needs.build-and-push.outputs.image-tag }} |" >> $GITHUB_STEP_SUMMARY
