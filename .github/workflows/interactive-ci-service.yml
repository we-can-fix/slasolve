---
name: äº’å‹•å¼ CI å®¢æœç³»çµ±ï¼ˆå¯é‡ç”¨ï¼‰

# æ­¤ workflow å¯è¢«ä»»ä½• CI workflow èª¿ç”¨ï¼Œç‚ºå…¶æ·»åŠ äº’å‹•å¼å®¢æœèƒ½åŠ›
on:
  workflow_call:
    inputs:
      ci-name:
        description: 'CI å·¥ä½œæµç¨‹åç¨±'
        required: true
        type: string
      ci-status:
        description: 'CI åŸ·è¡Œç‹€æ…‹ï¼ˆsuccess/failureï¼‰'
        required: true
        type: string
      ci-context:
        description: 'CI åŸ·è¡Œä¸Šä¸‹æ–‡è³‡è¨Šï¼ˆJSON æ ¼å¼ï¼‰'
        required: false
        type: string
        default: '{}'
      error-logs:
        description: 'éŒ¯èª¤æ—¥èªŒï¼ˆå¦‚æœ‰ï¼‰'
        required: false
        type: string
        default: ''
      pr-number:
        description: 'PR ç·¨è™Ÿ'
        required: false
        type: string
        default: ''
    outputs:
      service-response:
        description: "å®¢æœå›žæ‡‰å…§å®¹"
        value: ${{ jobs.interactive-service.outputs.response }}

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  interactive-service:
    name: ðŸ¤– äº’å‹•å¼å®¢æœ
    runs-on: ubuntu-latest
    outputs:
      response: ${{ steps.generate-response.outputs.response }}
    
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ðŸ” ç²å– PR ç·¨è™Ÿ
        id: get-pr
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            let prNumber = '${{ inputs.pr-number }}';
            
            if (!prNumber && context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            }
            
            console.log(`PR Number: ${prNumber}`);
            core.setOutput('pr_number', prNumber);
            return prNumber;
      
      - name: ðŸ¤– ç”Ÿæˆäº’å‹•å¼å›žæ‡‰
        id: generate-response
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const ciName = '${{ inputs.ci-name }}';
            const ciStatus = '${{ inputs.ci-status }}';
            const errorLogs = `${{ inputs.error-logs }}`;
            const prNumber = '${{ steps.get-pr.outputs.pr_number }}';
            
            if (!prNumber) {
              console.log('ç„¡ PR ç·¨è™Ÿï¼Œè·³éŽè©•è«–');
              return;
            }
            
            let response = '';
            let emoji = '';
            let color = '';
            
            if (ciStatus === 'success') {
              emoji = 'âœ…';
              color = 'ðŸŸ¢';
              response = `## ${emoji} ${ciName} - å®¢æœå ±å‘Š
              
              ${color} **ç‹€æ…‹**ï¼šåŸ·è¡ŒæˆåŠŸ
              
              ### ðŸ“‹ æœå‹™æ‘˜è¦
              - âœ“ æ‰€æœ‰æª¢æŸ¥é …ç›®å·²å®Œæˆ
              - âœ“ å“è³ªæ¨™æº–ç¬¦åˆè¦æ±‚
              - âœ“ æº–å‚™é€²è¡Œä¸‹ä¸€éšŽæ®µ
              
              ### ðŸ¤ äº’å‹•æœå‹™
              å¦‚éœ€å”åŠ©ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
              - \`@copilot help ${ciName}\` - ç²å–æ­¤ CI çš„è©³ç´°èªªæ˜Ž
              - \`@copilot analyze ${ciName}\` - æ·±åº¦åˆ†æžåŸ·è¡Œçµæžœ
              - \`@copilot report ${ciName}\` - ç”Ÿæˆè©³ç´°å ±å‘Š
              
              ---
              *æ­¤è©•è«–ç”± ${ciName} äº’å‹•å¼å®¢æœè‡ªå‹•ç”Ÿæˆ*
              `;
            } else {
              emoji = 'âŒ';
              color = 'ðŸ”´';
              
              // æ™ºèƒ½åˆ†æžéŒ¯èª¤é¡žåž‹
              let errorType = 'æœªçŸ¥éŒ¯èª¤';
              let recommendations = [];
              let quickFixes = [];
              
              if (errorLogs.includes('npm') || errorLogs.includes('node')) {
                errorType = 'Node.js/npm ç›¸é—œå•é¡Œ';
                recommendations = [
                  'æª¢æŸ¥ package.json ä¾è³´ç‰ˆæœ¬',
                  'æ¸…ç† node_modulesï¼š`rm -rf node_modules && npm install`',
                  'æª¢æŸ¥ Node.js ç‰ˆæœ¬æ˜¯å¦ >= 18'
                ];
                quickFixes = [
                  { cmd: 'npm install', desc: 'é‡æ–°å®‰è£ä¾è³´' },
                  { cmd: 'npm audit fix', desc: 'ä¿®å¾©å®‰å…¨å•é¡Œ' }
                ];
              } else if (errorLogs.includes('docker') || errorLogs.includes('Docker')) {
                errorType = 'Docker ç›¸é—œå•é¡Œ';
                recommendations = [
                  'æª¢æŸ¥ Dockerfile èªžæ³•',
                  'é©—è­‰åŸºç¤Žé¡åƒæ˜¯å¦å¯ç”¨',
                  'æ¸…ç† Docker å¿«å–ï¼š`docker system prune -a`'
                ];
                quickFixes = [
                  { cmd: 'docker-compose config', desc: 'é©—è­‰é…ç½®' },
                  { cmd: 'docker system df', desc: 'æª¢æŸ¥ç£ç›¤ç©ºé–“' }
                ];
              } else if (errorLogs.includes('test') || errorLogs.includes('Test')) {
                errorType = 'æ¸¬è©¦åŸ·è¡Œå•é¡Œ';
                recommendations = [
                  'æœ¬åœ°é‹è¡Œæ¸¬è©¦ï¼š`npm test`',
                  'æª¢æŸ¥æ¸¬è©¦ç’°å¢ƒé…ç½®',
                  'æŸ¥çœ‹å¤±æ•—çš„å…·é«”æ¸¬è©¦æ¡ˆä¾‹'
                ];
                quickFixes = [
                  { cmd: 'npm test -- --verbose', desc: 'è©³ç´°æ¸¬è©¦è¼¸å‡º' },
                  { cmd: 'npm run test:coverage', desc: 'æŸ¥çœ‹è¦†è“‹çŽ‡' }
                ];
              } else if (errorLogs.includes('lint') || errorLogs.includes('format')) {
                errorType = 'ä»£ç¢¼æ ¼å¼å•é¡Œ';
                recommendations = [
                  'é‹è¡Œ linterï¼š`npm run lint`',
                  'è‡ªå‹•ä¿®å¾©ï¼š`npm run lint:fix`',
                  'æª¢æŸ¥ ESLint é…ç½®'
                ];
                quickFixes = [
                  { cmd: 'npm run lint:fix', desc: 'è‡ªå‹•ä¿®å¾©æ ¼å¼' },
                  { cmd: 'npm run format', desc: 'æ ¼å¼åŒ–ä»£ç¢¼' }
                ];
              } else {
                recommendations = [
                  'æŸ¥çœ‹å®Œæ•´æ—¥èªŒä»¥äº†è§£å…·é«”éŒ¯èª¤',
                  'æª¢æŸ¥æœ€è¿‘çš„ä»£ç¢¼è®Šæ›´',
                  'åƒè€ƒ CI æ•…éšœæŽ’é™¤æ–‡æª”'
                ];
                quickFixes = [
                  { cmd: 'bash scripts/check-env.sh', desc: 'æª¢æŸ¥ç’°å¢ƒ' }
                ];
              }
              
              response = `## ${emoji} ${ciName} - å®¢æœå ±å‘Š
              
              ${color} **ç‹€æ…‹**ï¼šåŸ·è¡Œå¤±æ•—
              
              ### ðŸ” å•é¡Œè¨ºæ–·
              **éŒ¯èª¤é¡žåž‹**ï¼š${errorType}
              
              ### ðŸ’¡ ä¿®å¾©å»ºè­°
              ${recommendations.map((r, i) => `${i + 1}. ${r}`).join('\n')}
              
              ### âš¡ å¿«é€Ÿä¿®å¾©å‘½ä»¤
              ${quickFixes.map(f => `**${f.desc}**\n\`\`\`bash\n${f.cmd}\n\`\`\`\n`).join('\n')}
              
              ### ðŸ“Š éŒ¯èª¤æ‘˜è¦
              \`\`\`
              ${errorLogs ? errorLogs.substring(0, 500) + (errorLogs.length > 500 ? '...' : '') : 'æŸ¥çœ‹å®Œæ•´æ—¥èªŒä»¥ç²å–è©³ç´°è³‡è¨Š'}
              \`\`\`
              
              ### ðŸ¤ äº’å‹•å¼å®¢æœ
              éœ€è¦æ›´å¤šå”åŠ©ï¼Ÿä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
              - \`@copilot analyze ${ciName}\` - æ·±åº¦åˆ†æžæ­¤éŒ¯èª¤
              - \`@copilot fix ${ciName}\` - ç²å–è‡ªå‹•ä¿®å¾©å»ºè­°
              - \`@copilot help ${ciName}\` - æŸ¥çœ‹æ­¤ CI çš„å®Œæ•´æ–‡æª”
              - \`@copilot similar ${ciName}\` - æŸ¥æ‰¾ç›¸ä¼¼å•é¡Œçš„è§£æ±ºæ–¹æ¡ˆ
              
              ### ðŸ“š ç›¸é—œè³‡æº
              - [CI æ•…éšœæŽ’é™¤æ–‡æª”](./docs/ci-troubleshooting.md)
              - [${ciName} ç‰¹å®šæ–‡æª”](./docs/)
              - [ç’°å¢ƒæª¢æŸ¥å·¥å…·](./scripts/check-env.sh)
              
              ---
              *æ­¤è©•è«–ç”± ${ciName} äº’å‹•å¼å®¢æœè‡ªå‹•ç”Ÿæˆ*
              `;
            }
            
            core.setOutput('response', response);
            
            // ç™¼å¸ƒæˆ–æ›´æ–°è©•è«–
            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });
              
              // æŸ¥æ‰¾æ­¤ CI çš„ç¾æœ‰è©•è«–
              const existingComment = comments.find(c => 
                c.user.type === 'Bot' && c.body.includes(`${ciName} - å®¢æœå ±å‘Š`)
              );
              
              if (existingComment) {
                // æ›´æ–°ç¾æœ‰è©•è«–
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: response
                });
                console.log(`æ›´æ–°äº† ${ciName} çš„è©•è«–`);
              } else {
                // å‰µå»ºæ–°è©•è«–
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: response
                });
                console.log(`å‰µå»ºäº† ${ciName} çš„æ–°è©•è«–`);
              }
            } catch (error) {
              console.error('è©•è«–æ“ä½œå¤±æ•—ï¼š', error.message);
            }
            
            return response;
      
      - name: ðŸ·ï¸ ç®¡ç†æ¨™ç±¤
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const ciName = '${{ inputs.ci-name }}';
            const ciStatus = '${{ inputs.ci-status }}';
            const prNumber = '${{ steps.get-pr.outputs.pr_number }}';
            
            if (!prNumber) return;
            
            // æ¸…ç† CI åç¨±ä½œç‚ºæ¨™ç±¤
            const labelName = `ci-${ciName.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`;
            
            try {
              if (ciStatus === 'failure') {
                // æ·»åŠ å¤±æ•—æ¨™ç±¤
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: [labelName + '-failed', 'ci-needs-attention']
                });
                console.log(`æ·»åŠ æ¨™ç±¤: ${labelName}-failed`);
              } else {
                // ç§»é™¤å¤±æ•—æ¨™ç±¤
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    name: labelName + '-failed'
                  });
                  console.log(`ç§»é™¤æ¨™ç±¤: ${labelName}-failed`);
                } catch (e) {
                  console.log('æ¨™ç±¤ä¸å­˜åœ¨ï¼Œè·³éŽç§»é™¤');
                }
              }
            } catch (error) {
              console.error('æ¨™ç±¤ç®¡ç†å¤±æ•—ï¼š', error.message);
            }
      
      - name: ðŸ“Š ç”Ÿæˆæœå‹™æ‘˜è¦
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ¤– ${{ inputs.ci-name }} äº’å‹•å¼å®¢æœå ±å‘Š
          
          **ç‹€æ…‹**: ${{ inputs.ci-status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}
          
          **æœå‹™åŠŸèƒ½**:
          - âœ“ è‡ªå‹•è¨ºæ–·å•é¡Œ
          - âœ“ æä¾›ä¿®å¾©å»ºè­°
          - âœ“ äº’å‹•å¼å‘½ä»¤æ”¯æ´
          - âœ“ æ™ºèƒ½æ¨™ç±¤ç®¡ç†
          
          **äº’å‹•å‘½ä»¤**:
          - \`@copilot analyze ${{ inputs.ci-name }}\`
          - \`@copilot fix ${{ inputs.ci-name }}\`
          - \`@copilot help ${{ inputs.ci-name }}\`
          EOF
