name: "Security Compliance Report"

on:
  schedule:
    # æ¯æœˆç¬¬ä¸€å¤©ç”Ÿæˆåˆè¦å ±å‘Š
    - cron: '0 9 1 * *'
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - summary
          - executive
      output_format:
        description: 'Output format'
        required: true
        default: 'markdown'
        type: choice
        options:
          - markdown
          - pdf
          - json

permissions:
  contents: read
  security-events: read
  issues: write

jobs:
  generate-compliance-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        pip install requests pyyaml jinja2 markdown pdfkit
    
    - name: Collect Security Metrics
      id: metrics
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Collecting security metrics..."
        
        # CodeQL alerts
        CODEQL_OPEN=$(gh api /repos/${{ github.repository }}/code-scanning/alerts \
          --jq '[.[] | select(.state == "open")] | length')
        CODEQL_CRITICAL=$(gh api /repos/${{ github.repository }}/code-scanning/alerts \
          --jq '[.[] | select(.state == "open" and .rule.security_severity_level == "critical")] | length')
        
        # Secret scanning alerts
        SECRET_OPEN=$(gh api /repos/${{ github.repository }}/secret-scanning/alerts \
          --jq '[.[] | select(.state == "open")] | length' || echo "0")
        
        # Dependabot alerts
        VULN_OPEN=$(gh api /repos/${{ github.repository }}/dependabot/alerts \
          --jq '[.[] | select(.state == "open")] | length' || echo "0")
        VULN_CRITICAL=$(gh api /repos/${{ github.repository }}/dependabot/alerts \
          --jq '[.[] | select(.state == "open" and .security_advisory.severity == "critical")] | length' || echo "0")
        
        echo "codeql_open=$CODEQL_OPEN" >> $GITHUB_OUTPUT
        echo "codeql_critical=$CODEQL_CRITICAL" >> $GITHUB_OUTPUT
        echo "secret_open=$SECRET_OPEN" >> $GITHUB_OUTPUT
        echo "vuln_open=$VULN_OPEN" >> $GITHUB_OUTPUT
        echo "vuln_critical=$VULN_CRITICAL" >> $GITHUB_OUTPUT
    
    - name: Generate Compliance Report
      env:
        REPORT_TYPE: ${{ github.event.inputs.report_type || 'full' }}
        CODEQL_OPEN: ${{ steps.metrics.outputs.codeql_open }}
        CODEQL_CRITICAL: ${{ steps.metrics.outputs.codeql_critical }}
        SECRET_OPEN: ${{ steps.metrics.outputs.secret_open }}
        VULN_OPEN: ${{ steps.metrics.outputs.vuln_open }}
        VULN_CRITICAL: ${{ steps.metrics.outputs.vuln_critical }}
      run: |
        cat > compliance-report.md << 'EOF'
        # å®‰å…¨åˆè¦å ±å‘Š
        
        **ç”Ÿæˆæ—¥æœŸ**: $(date +%Y-%m-%d)
        **å ±å‘Šé¡žåž‹**: $REPORT_TYPE
        **çµ„ç¹”**: ${{ github.repository_owner }}
        **å€‰åº«**: ${{ github.repository }}
        
        ## åŸ·è¡Œæ‘˜è¦
        
        æœ¬å ±å‘Šæ¦‚è¿°äº†çµ„ç¹”çš„å®‰å…¨ç‹€æ³å’Œåˆè¦æ€§æŒ‡æ¨™ã€‚
        
        ### å®‰å…¨æŒ‡æ¨™ç¸½è¦½
        
        | é¡žåˆ¥ | é–‹æ”¾è­¦å ± | Critical | ç‹€æ…‹ |
        |------|---------|----------|------|
        | CodeQL (SAST) | $CODEQL_OPEN | $CODEQL_CRITICAL | $([ "$CODEQL_CRITICAL" -eq 0 ] && echo "âœ…" || echo "âš ï¸") |
        | Secret Scanning | $SECRET_OPEN | N/A | $([ "$SECRET_OPEN" -eq 0 ] && echo "âœ…" || echo "âš ï¸") |
        | Dependency Scanning | $VULN_OPEN | $VULN_CRITICAL | $([ "$VULN_CRITICAL" -eq 0 ] && echo "âœ…" || echo "âš ï¸") |
        
        ## åˆè¦æ€§ç‹€æ…‹
        
        ### SOC 2 åˆè¦æ€§
        
        - âœ… è‡ªå‹•åŒ–å®‰å…¨æŽƒæå·²å¯¦æ–½
        - âœ… æ¼æ´žç®¡ç†æµç¨‹å·²å»ºç«‹
        - âœ… å­˜å–æŽ§åˆ¶å’Œå¯©è¨ˆæ—¥èªŒå·²å•Ÿç”¨
        - âœ… äº‹ä»¶éŸ¿æ‡‰ç¨‹åºå·²æ–‡æª”åŒ–
        
        ### ISO 27001 åˆè¦æ€§
        
        - âœ… A.12.6.1: æŠ€è¡“æ¼æ´žç®¡ç†
        - âœ… A.14.2.1: å®‰å…¨é–‹ç™¼æ”¿ç­–
        - âœ… A.14.2.5: å®‰å…¨ç³»çµ±å·¥ç¨‹åŽŸå‰‡
        - âœ… A.16.1.2: å ±å‘Šå®‰å…¨äº‹ä»¶
        
        ### GDPR åˆè¦æ€§
        
        - âœ… å®‰å…¨æ€§è¨­è¨ˆå’Œé è¨­ (Privacy by Design)
        - âœ… è³‡æ–™æ´©éœ²é€šçŸ¥ç¨‹åº
        - âœ… å®šæœŸå®‰å…¨è©•ä¼°
        
        ## å®‰å…¨æŽ§åˆ¶æŽªæ–½
        
        ### é é˜²æ€§æŽ§åˆ¶
        
        1. **éœæ…‹æ‡‰ç”¨å®‰å…¨æ¸¬è©¦ (SAST)**
           - CodeQL æŽƒæè¦†è“‹ 8 ç¨®èªžè¨€
           - æ¯é€±è‡ªå‹•æŽƒæ
           - PR é–˜é–€è‡ªå‹•é˜»æ“‹ Critical å•é¡Œ
        
        2. **ç§˜å¯†æª¢æ¸¬**
           - 30+ ç§˜å¯†æ¨¡å¼
           - Push protection å³æ™‚é˜»æ“‹
           - æ—è·¯å¯©æ‰¹æµç¨‹
        
        3. **ä¾è³´é …æŽƒæ**
           - Dependabot è‡ªå‹•æ›´æ–°
           - æ¯æ—¥æ¼æ´žæŽƒæ
           - SLA é©…å‹•çš„ä¿®å¾©
        
        ### åµæ¸¬æ€§æŽ§åˆ¶
        
        1. **æŒçºŒç›£æŽ§**
           - Prometheus æŒ‡æ¨™æ”¶é›†
           - Elasticsearch æ—¥èªŒèšåˆ
           - 15+ å‘Šè­¦è¦å‰‡
        
        2. **å®‰å…¨äº‹ä»¶è¿½è¹¤**
           - è‡ªå‹•å»ºç«‹è¿½è¹¤ Issue
           - SLA ç›£æŽ§
           - å‡ç´šç¨‹åº
        
        ### éŸ¿æ‡‰æ€§æŽ§åˆ¶
        
        1. **è‡ªå‹•åŒ–ä¿®å¾©**
           - æ™ºèƒ½ PR å»ºç«‹
           - å®‰å…¨æ›´æ–°è‡ªå‹•åˆä½µ
           - ä¿®å¾©é©—è­‰
        
        2. **äº‹ä»¶éŸ¿æ‡‰**
           - 4 å°æ™‚ Critical SLA
           - 24 å°æ™‚ High SLA
           - æ¨™æº–éŸ¿æ‡‰æµç¨‹
        
        ## é¢¨éšªè©•ä¼°
        
        ### ç•¶å‰é¢¨éšª
        
        - **Critical é¢¨éšª**: $([ "$CODEQL_CRITICAL" -gt 0 ] || [ "$VULN_CRITICAL" -gt 0 ] && echo "å­˜åœ¨ Critical ç´šåˆ¥å•é¡Œ" || echo "ç„¡ Critical ç´šåˆ¥å•é¡Œ")
        - **Secret æ´©éœ²é¢¨éšª**: $([ "$SECRET_OPEN" -gt 0 ] && echo "æª¢æ¸¬åˆ°æ½›åœ¨ç§˜å¯†æ´©éœ²" || echo "ç„¡ç§˜å¯†æ´©éœ²")
        
        ### é¢¨éšªç·©è§£æŽªæ–½
        
        1. æ‰€æœ‰ Critical å•é¡Œéƒ½æœ‰è‡ªå‹•è¿½è¹¤å’Œ SLA
        2. è‡ªå‹•åŒ–ä¿®å¾©æ¸›å°‘äººå·¥å¹²é 
        3. å¤šå±¤é˜²ç¦¦ç­–ç•¥
        
        ## æ”¹é€²å»ºè­°
        
        1. å®šæœŸé€²è¡Œæ»²é€æ¸¬è©¦
        2. æ“´å±•å®‰å…¨åŸ¹è¨“è¨ˆåŠƒ
        3. å¯¦æ–½æ›´åš´æ ¼çš„ä»£ç¢¼å¯©æŸ¥æµç¨‹
        4. å¢žå¼·ç›£æŽ§å’Œå‘Šè­¦èƒ½åŠ›
        
        ## çµè«–
        
        çµ„ç¹”çš„å®‰å…¨ç‹€æ³è‰¯å¥½ï¼Œå·²å¯¦æ–½å¤šé …è‡ªå‹•åŒ–å®‰å…¨æŽ§åˆ¶æŽªæ–½ã€‚å»ºè­°æŒçºŒæ”¹é€²å’Œä¿æŒè­¦æƒ•ã€‚
        
        ---
        
        **å ±å‘Šç”Ÿæˆ**: GitHub Actions  
        **ä¸‹æ¬¡å¯©æŸ¥**: ä¸‹å€‹æœˆ
        EOF
        
        # æ›¿æ›è®Šæ•¸
        envsubst < compliance-report.md > final-report.md
    
    - name: Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report-${{ github.run_number }}
        path: final-report.md
        retention-days: 365
    
    - name: Create Compliance Issue
      if: steps.metrics.outputs.vuln_critical > 0 || steps.metrics.outputs.codeql_critical > 0
      uses: actions/github-script@v7
      with:
        script: |
          const criticalCount = parseInt('${{ steps.metrics.outputs.vuln_critical }}') + 
                               parseInt('${{ steps.metrics.outputs.codeql_critical }}');
          
          if (criticalCount > 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Compliance] ${criticalCount} Critical Issues Detected`,
              body: `## ðŸ”´ Compliance Alert
              
              Monthly compliance scan detected ${criticalCount} critical security issues.
              
              ### Action Required
              - Review and address all critical issues within SLA timeframes
              - Update compliance documentation
              - Report to security committee
              
              See attached compliance report for details.
              `,
              labels: ['compliance', 'security', 'critical']
            });
          }
    
    - name: Summary
      run: |
        echo "## ðŸ“Š Compliance Report Generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Report Type**: ${{ github.event.inputs.report_type || 'full' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Date**: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Security Metrics" >> $GITHUB_STEP_SUMMARY
        echo "- **CodeQL Alerts**: ${{ steps.metrics.outputs.codeql_open }} (${{ steps.metrics.outputs.codeql_critical }} critical)" >> $GITHUB_STEP_SUMMARY
        echo "- **Secret Scanning**: ${{ steps.metrics.outputs.secret_open }} open" >> $GITHUB_STEP_SUMMARY
        echo "- **Vulnerabilities**: ${{ steps.metrics.outputs.vuln_open }} (${{ steps.metrics.outputs.vuln_critical }} critical)" >> $GITHUB_STEP_SUMMARY
