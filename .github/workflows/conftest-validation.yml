name: Policy Validation

"on":
  pull_request:
    paths:
      - 'deploy/**'
      - 'templates/**'
      - '.config/conftest/**'

jobs:
  conftest-check:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: ðŸ”§ Setup Conftest
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v0.49.1/conftest_0.49.1_Linux_x86_64.tar.gz
          tar xzf conftest_0.49.1_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: ðŸ” Validate Kubernetes manifests
        run: |
          if [ -d "deploy" ]; then
            echo "æª¢æŸ¥ deploy/ ç›®éŒ„"
            find deploy -name "*.yaml" -o -name "*.yml" | while read file; do
              echo "é©—è­‰: $file"
              conftest test "$file" -p .config/conftest/policies/ || true
            done
          fi

      - name: ðŸ” Validate templates
        run: |
          if [ -d "templates" ]; then
            echo "æª¢æŸ¥ templates/ ç›®éŒ„"
            find templates -name "*.yaml" -o -name "*.yml" | while read file; do
              echo "é©—è­‰: $file"
              conftest test "$file" -p .config/conftest/policies/ || true
            done
          fi

      - name: ðŸ“Š Generate report
        if: always()
        run: |
          echo "## ðŸ”’ Policy Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Conftest æ”¿ç­–é©—è­‰å·²åŸ·è¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æª¢æŸ¥ç¯„åœï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- deploy/ ç›®éŒ„" >> $GITHUB_STEP_SUMMARY
          echo "- templates/ ç›®éŒ„" >> $GITHUB_STEP_SUMMARY
