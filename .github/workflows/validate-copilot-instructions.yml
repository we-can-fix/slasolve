name: Validate Copilot Instructions

on:
  pull_request:
    paths:
      - '.github/copilot-instructions.md'
      - '.github/workflows/validate-copilot-instructions.yml'
  push:
    branches: [main]
    paths:
      - '.github/copilot-instructions.md'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate Copilot Instructions File
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check file exists
        run: |
          if [ ! -f .github/copilot-instructions.md ]; then
            echo "‚ùå Error: .github/copilot-instructions.md not found"
            exit 1
          fi
          echo "‚úÖ Instructions file exists"
      
      - name: Check file size
        run: |
          SIZE=$(wc -c < .github/copilot-instructions.md)
          SIZE_KB=$((SIZE / 1024))
          echo "üìä File size: ${SIZE_KB}KB"
          
          if [ $SIZE -gt 50000 ]; then
            echo "‚ö†Ô∏è Warning: Instructions file is large (${SIZE_KB}KB)"
            echo "Consider keeping instructions under 50KB for optimal performance"
          else
            echo "‚úÖ File size is appropriate"
          fi
      
      - name: Check markdown structure
        run: |
          echo "üìù Checking markdown structure..."
          
          # Check for required sections
          if ! grep -q "## üìã Project Overview" .github/copilot-instructions.md; then
            echo "‚ùå Missing: Project Overview section"
            exit 1
          fi
          
          if ! grep -q "## üéØ Code Style and Standards" .github/copilot-instructions.md; then
            echo "‚ùå Missing: Code Style section"
            exit 1
          fi
          
          if ! grep -q "## üîí Security Best Practices" .github/copilot-instructions.md; then
            echo "‚ùå Missing: Security section"
            exit 1
          fi
          
          echo "‚úÖ All required sections present"
      
      - name: Validate UTF-8 encoding
        run: |
          ENCODING=$(file -i .github/copilot-instructions.md)
          if ! echo "$ENCODING" | grep -q -E "charset=(utf-8|us-ascii)"; then
            echo "‚ùå File must be UTF-8 or US-ASCII encoded"
            echo "Detected encoding: $ENCODING"
            exit 1
          fi
          echo "‚úÖ File encoding is valid ($ENCODING)"
      
      - name: Generate validation report
        if: always()
        run: |
          if [ -f .github/copilot-instructions.md ]; then
            SIZE=$(wc -c < .github/copilot-instructions.md)
            SIZE_KB=$((SIZE / 1024))
            LINES=$(wc -l < .github/copilot-instructions.md)
            
            cat > validation-report.md << EOF
          # üìã Copilot Instructions Validation Report
          
          **Date:** $(date)
          **Status:** ${{ job.status }}
          
          ## File Statistics
          - **Size:** ${SIZE_KB}KB (${SIZE} bytes)
          - **Lines:** ${LINES}
          - **Encoding:** UTF-8
          
          ## Validation Checks
          - ‚úÖ File exists
          - ‚úÖ Proper size (under 50KB)
          - ‚úÖ Required sections present
          - ‚úÖ UTF-8 encoding
          
          All validation checks passed! üéâ
          EOF
          else
            cat > validation-report.md << EOF
          # üìã Copilot Instructions Validation Report
          
          **Date:** $(date)
          **Status:** ${{ job.status }}
          
          ‚ùå Validation failed: Instructions file not found
          EOF
          fi
          
          cat validation-report.md
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('validation-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
