---
name: ğŸ”§ Stage 1 - åŸºç¤ CI è‡ªå‹•è©•è«–

on:
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  basic-checks:
    name: åŸºç¤æª¢æŸ¥èˆ‡æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸŸ¢ è¨­å®š Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ å®‰è£ä¾è³´ï¼ˆRootï¼‰
        run: npm install
      
      - name: ğŸ” ç’°å¢ƒå¥åº·æª¢æŸ¥
        id: health-check
        run: |
          echo "## ç’°å¢ƒè³‡è¨Š" > health-check.log
          echo "- Node ç‰ˆæœ¬: $(node --version)" >> health-check.log
          echo "- NPM ç‰ˆæœ¬: $(npm --version)" >> health-check.log
          echo "- ä½œæ¥­ç³»çµ±: $(uname -s)" >> health-check.log
          echo "- æ ¸å¿ƒç‰ˆæœ¬: $(uname -r)" >> health-check.log
          echo "" >> health-check.log
          echo "âœ… ç’°å¢ƒå¥åº·æª¢æŸ¥å®Œæˆ" >> health-check.log
          
          cat health-check.log
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: ğŸ§ª é‹è¡ŒåŸºç¤æ¸¬è©¦ï¼ˆContracts L1ï¼‰
        id: tests-contracts
        working-directory: core/contracts/contracts-L1/contracts
        run: |
          echo "é–‹å§‹æ¸¬è©¦ Contracts L1 æœå‹™..."
          npm ci
          
          # é‹è¡Œæ¸¬è©¦ä¸¦æ•ç²è¼¸å‡º
          if npm test -- --ci --passWithNoTests 2>&1 | tee test-output.log; then
            TEST_RESULT=0
            echo "âœ… Contracts L1 æ¸¬è©¦é€šé"
          else
            TEST_RESULT=1
            echo "âŒ Contracts L1 æ¸¬è©¦å¤±æ•—"
          fi
          
          echo "result=$TEST_RESULT" >> $GITHUB_OUTPUT
          echo "service=contracts-l1" >> $GITHUB_OUTPUT
      
      - name: ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡æª¢æŸ¥
        id: coverage
        if: always()
        working-directory: core/contracts/contracts-L1/contracts
        run: |
          # å˜—è©¦å¾æ¸¬è©¦è¼¸å‡ºæå–è¦†è“‹ç‡è³‡è¨Š
          if [ -f test-output.log ]; then
            # å¾æ¸¬è©¦è¼¸å‡ºä¸­æå– "All files" è¡Œçš„ Statements è¦†è“‹ç‡
            COVERAGE=$(grep "All files" test-output.log | grep -oP '\|\s+\K[0-9.]+' | head -1)
            if [ -n "$COVERAGE" ]; then
              echo "è¦†è“‹ç‡: ${COVERAGE}%"
              echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            else
              echo "coverage=N/A" >> $GITHUB_OUTPUT
              echo "ç„¡æ³•å¾æ¸¬è©¦è¼¸å‡ºæå–è¦†è“‹ç‡è³‡è¨Š"
            fi
          else
            echo "coverage=N/A" >> $GITHUB_OUTPUT
            echo "æ¸¬è©¦è¼¸å‡ºæª”æ¡ˆä¸å­˜åœ¨"
          fi
      
      - name: ğŸ“ è‡ªå‹•è©•è«–ï¼ˆåŸºç¤ç‰ˆï¼‰
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const testResult = parseInt('${{ steps.tests-contracts.outputs.result }}');
            const healthStatus = '${{ steps.health-check.outputs.status }}';
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // æ§‹å»ºè©•è«–å…§å®¹
            let comment = '## ğŸ”§ Stage 1 - åŸºç¤ CI æª¢æŸ¥çµæœ\n\n';
            
            // æ¸¬è©¦çµæœ
            if (testResult === 0) {
              comment += '### âœ… æ¸¬è©¦çµæœï¼šé€šé\n\n';
              comment += 'æ‰€æœ‰åŸºç¤æ¸¬è©¦å·²æˆåŠŸé€šéï¼\n\n';
            } else {
              comment += '### âŒ æ¸¬è©¦çµæœï¼šå¤±æ•—\n\n';
              comment += 'éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¸¬è©¦æ—¥èªŒã€‚\n\n';
            }
            
            // ç’°å¢ƒæª¢æŸ¥
            comment += '### ğŸ” ç’°å¢ƒå¥åº·æª¢æŸ¥\n\n';
            if (healthStatus === 'success') {
              comment += 'âœ… ç’°å¢ƒé…ç½®æ­£å¸¸\n\n';
            } else {
              comment += 'âš ï¸ ç’°å¢ƒé…ç½®å¯èƒ½å­˜åœ¨å•é¡Œ\n\n';
            }
            
            // è¦†è“‹ç‡è³‡è¨Š
            if (coverage !== 'N/A') {
              comment += '### ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡\n\n';
              comment += `ç•¶å‰è¦†è“‹ç‡ï¼š**${coverage}%**\n\n`;
              
              const coverageNum = parseFloat(coverage);
              if (coverageNum >= 80) {
                comment += 'âœ… è¦†è“‹ç‡ç¬¦åˆè¦æ±‚ï¼ˆâ‰¥80%ï¼‰\n\n';
              } else if (coverageNum >= 60) {
                comment += 'âš ï¸ è¦†è“‹ç‡åä½ï¼Œå»ºè­°æå‡è‡³ 80% ä»¥ä¸Š\n\n';
              } else {
                comment += 'âŒ è¦†è“‹ç‡éä½ï¼Œéœ€è¦å¢åŠ æ¸¬è©¦\n\n';
              }
            }
            
            // æª¢æŸ¥è©³æƒ…
            comment += '### ğŸ“‹ æª¢æŸ¥è©³æƒ…\n\n';
            comment += '| é …ç›® | ç‹€æ…‹ |\n';
            comment += '|------|------|\n';
            comment += `| Contracts L1 æ¸¬è©¦ | ${testResult === 0 ? 'âœ… é€šé' : 'âŒ å¤±æ•—'} |\n`;
            comment += `| ç’°å¢ƒå¥åº·æª¢æŸ¥ | ${healthStatus === 'success' ? 'âœ… é€šé' : 'âš ï¸ è­¦å‘Š'} |\n`;
            comment += `| æ¸¬è©¦è¦†è“‹ç‡ | ${coverage !== 'N/A' ? coverage + '%' : 'N/A'} |\n\n`;
            
            // å»ºè­°èˆ‡å¾ŒçºŒæ­¥é©Ÿ
            comment += '### ğŸ’¡ å»ºè­°èˆ‡å¾ŒçºŒæ­¥é©Ÿ\n\n';
            if (testResult === 0) {
              comment += '- âœ… æ‰€æœ‰åŸºç¤æª¢æŸ¥é€šéï¼Œå¯ä»¥ç¹¼çºŒé€²è¡Œä»£ç¢¼å¯©æŸ¥\n';
              comment += '- ğŸ“ ç¢ºä¿ä»£ç¢¼ç¬¦åˆå°ˆæ¡ˆç·¨ç¢¼è¦ç¯„\n';
              comment += '- ğŸ”’ é€²è¡Œå®‰å…¨æ€§æª¢æŸ¥\n';
            } else {
              comment += '- âŒ è«‹å…ˆä¿®å¾©å¤±æ•—çš„æ¸¬è©¦\n';
              comment += '- ğŸ” æŸ¥çœ‹è©³ç´°çš„æ¸¬è©¦æ—¥èªŒä»¥äº†è§£å¤±æ•—åŸå› \n';
              comment += '- ğŸ“š åƒè€ƒæ¸¬è©¦æ–‡æª”ä»¥äº†è§£æ¸¬è©¦è¦æ±‚\n';
            }
            
            comment += `\n---\nğŸ“Š [æŸ¥çœ‹å®Œæ•´ CI æ—¥èªŒ](${runUrl})\n`;
            comment += `â° æª¢æŸ¥æ™‚é–“ï¼š${new Date().toISOString()}\n`;
            
            // ç™¼å¸ƒè©•è«–
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: ğŸ“Š CI æ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ¯ Stage 1 åŸºç¤ CI æª¢æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æª¢æŸ¥çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.tests-contracts.outputs.result }}" = "0" ]; then
            echo "âœ… **æ¸¬è©¦ç‹€æ…‹**ï¼šé€šé" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ¸¬è©¦ç‹€æ…‹**ï¼šå¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "âœ… **ç’°å¢ƒæª¢æŸ¥**ï¼š${{ steps.health-check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.coverage.outputs.coverage }}" != "N/A" ]; then
            echo "ğŸ“Š **æ¸¬è©¦è¦†è“‹ç‡**ï¼š${{ steps.coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ æœå‹™ä½ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- Contracts L1: \`core/contracts/contracts-L1/contracts/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ **Stage 1** - åŸºç¤ CI è‡ªå‹•è©•è«–æ©Ÿåˆ¶" >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ å¤±æ•—æ™‚é€€å‡º
        if: steps.tests-contracts.outputs.result != '0'
        run: |
          echo "æ¸¬è©¦å¤±æ•—ï¼ŒCI æª¢æŸ¥æœªé€šé"
          exit 1
