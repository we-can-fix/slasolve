---
name: CI è‡ªå‹•è©•è«–èˆ‡éŒ¯èª¤å°èˆªç³»çµ±

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  DOCKER_COMPOSE_VERSION: "2.20.0"
  NODE_VERSION: "18"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ============================================
  # ç¬¬ä¸€éšæ®µï¼šç’°å¢ƒæª¢æŸ¥èˆ‡ä¾è³´é©—è­‰
  # ============================================
  environment-check:
    runs-on: ubuntu-latest
    outputs:
      docker_status: ${{ steps.docker-check.outputs.status }}
      compose_status: ${{ steps.compose-check.outputs.status }}
      error_message: ${{ steps.error-handler.outputs.message }}
      error_type: ${{ steps.error-handler.outputs.type }}
      solution: ${{ steps.error-handler.outputs.solution }}
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      # ========== Docker æª¢æŸ¥ ==========
      - name: ğŸ³ æª¢æŸ¥ Docker å®‰è£
        id: docker-check
        run: |
          if command -v docker &> /dev/null; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ“ Docker å·²å®‰è£ï¼š$(docker --version)"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âœ— Docker æœªå®‰è£"
            exit 1
          fi
        continue-on-error: true
      
      # ========== Docker Compose æª¢æŸ¥ ==========
      - name: ğŸ”§ æª¢æŸ¥ Docker Compose å®‰è£
        id: compose-check
        run: |
          if command -v docker-compose &> /dev/null || docker compose version &> /dev/null; then
            echo "status=success" >> $GITHUB_OUTPUT
            if command -v docker-compose &> /dev/null; then
              echo "âœ“ Docker Compose å·²å®‰è£ï¼š$(docker-compose --version)"
            else
              echo "âœ“ Docker Compose Plugin å·²å®‰è£ï¼š$(docker compose version)"
            fi
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âœ— Docker Compose æœªå®‰è£"
            exit 1
          fi
        continue-on-error: true
      
      # ========== éŒ¯èª¤è™•ç†èˆ‡åˆ†é¡ ==========
      - name: ğŸš¨ éŒ¯èª¤åˆ†é¡èˆ‡æ¶ˆæ¯ç”Ÿæˆ
        id: error-handler
        if: ${{ failure() }}
        run: |
          ERROR_TYPE="UNKNOWN"
          ERROR_MSG="CI æª¢æŸ¥å¤±æ•—"
          SOLUTION=""
          
          if [ "${{ steps.docker-check.outputs.status }}" = "failed" ]; then
            ERROR_TYPE="DOCKER_NOT_INSTALLED"
            ERROR_MSG="âŒ Docker æœªå®‰è£æˆ–ä¸å¯ç”¨"
            SOLUTION="è«‹åœ¨æœ¬åœ°åŸ·è¡Œï¼š\`curl -fsSL https://get.docker.com | sh\`"
          elif [ "${{ steps.compose-check.outputs.status }}" = "failed" ]; then
            ERROR_TYPE="DOCKER_COMPOSE_NOT_INSTALLED"
            ERROR_MSG="âŒ Docker Compose æœªå®‰è£æˆ–ç‰ˆæœ¬éèˆŠ"
            SOLUTION="è«‹åŸ·è¡Œï¼š\`sudo curl -L https://github.com/docker/compose/releases/download/v${DOCKER_COMPOSE_VERSION}/docker-compose-\$(uname -s)-\$(uname -m) -o /usr/local/bin/docker-compose && sudo chmod +x /usr/local/bin/docker-compose\`"
          fi
          
          echo "type=$ERROR_TYPE" >> $GITHUB_OUTPUT
          echo "message=$ERROR_MSG" >> $GITHUB_OUTPUT
          echo "solution=$SOLUTION" >> $GITHUB_OUTPUT
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âš ï¸ ç’°å¢ƒæª¢æŸ¥å¤±æ•—
          - **éŒ¯èª¤é¡å‹**ï¼š$ERROR_TYPE
          - **è©³æƒ…**ï¼š$ERROR_MSG
          - **ä¿®æ­£æ–¹æ¡ˆ**ï¼š$SOLUTION
          EOF
      
      # ========== GitHub Annotationï¼ˆç›´æ¥æ¨™è¨˜éŒ¯èª¤ï¼‰==========
      - name: ğŸ“ æ¨™è¨˜éŒ¯èª¤ä½ç½®ï¼ˆAnnotationï¼‰
        if: ${{ failure() }}
        run: |
          echo "::error title=ç’°å¢ƒæª¢æŸ¥å¤±æ•—::Docker æˆ– Docker Compose æœªå®‰è£ã€‚è«‹åƒè€ƒ PR è©•è«–ç²å–ä¿®æ­£æ–¹æ¡ˆã€‚"
          echo "::notice title=ä¿®æ­£æ­¥é©Ÿ::åŸ·è¡Œæœ¬åœ°ç’°å¢ƒæª¢æŸ¥ï¼šbash scripts/check-env.sh"

  # ============================================
  # ç¬¬äºŒéšæ®µï¼šæ§‹å»ºèˆ‡æ¸¬è©¦
  # ============================================
  build-and-test:
    needs: environment-check
    runs-on: ubuntu-latest
    if: ${{ needs.environment-check.outputs.docker_status == 'success' && needs.environment-check.outputs.compose_status == 'success' }}
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ”¨ æ§‹å»º Docker é¡åƒ
        id: build
        shell: bash
        run: |
          set -o pipefail
          
          # ä½¿ç”¨ docker compose æˆ– docker-compose
          if command -v docker-compose &> /dev/null; then
            COMPOSE_CMD="docker-compose"
          else
            COMPOSE_CMD="docker compose"
          fi
          
          if $COMPOSE_CMD build --no-cache 2>&1 | tee build.log; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error_log<<EOF" >> $GITHUB_OUTPUT
            cat build.log | tail -20 >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: ğŸ§ª é‹è¡Œæ¸¬è©¦
        id: test
        shell: bash
        run: |
          set -o pipefail
          
          # æ³¨æ„ï¼šæ­¤éšæ®µä½¿ç”¨ä¸»æ©Ÿç’°å¢ƒé‹è¡Œæ¸¬è©¦è€Œé Docker å®¹å™¨
          # åŸå› ï¼šå·²çŸ¥ Docker å®¹å™¨å…§ npm ci å­˜åœ¨ "Exit handler never called" å•é¡Œ
          # é€™èˆ‡ç¾æœ‰çš„ core-services-ci.yml æ–¹æ³•ä¸€è‡´ï¼Œç¢ºä¿ç’°å¢ƒä¸€è‡´æ€§
          # åƒè€ƒï¼šcore-services-ci.yml ä¸­å„æœå‹™çš„æ¸¬è©¦æ–¹æ³•
          
          if npm install --workspaces 2>&1 | tee test.log && npm test 2>&1 | tee -a test.log; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error_log<<EOF" >> $GITHUB_OUTPUT
            cat test.log | tail -30 >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: ğŸ“Š ç”Ÿæˆæ¸¬è©¦å ±å‘Š
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ”¨ æ§‹å»ºç‹€æ…‹
          - æ§‹å»ºçµæœï¼š${{ steps.build.outputs.status }}
          
          ## ğŸ§ª æ¸¬è©¦ç‹€æ…‹
          - æ¸¬è©¦çµæœï¼š${{ steps.test.outputs.status }}
          EOF

  # ============================================
  # ç¬¬ä¸‰éšæ®µï¼šè‡ªå‹•è©•è«–èˆ‡æ¨™ç±¤æ©Ÿåˆ¶
  # ============================================
  auto-comment:
    needs: [environment-check, build-and-test]
    runs-on: ubuntu-latest
    if: always()  # ç„¡è«–æˆåŠŸæˆ–å¤±æ•—éƒ½åŸ·è¡Œ
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      # ========== æƒ…æ³ 1ï¼šç’°å¢ƒæª¢æŸ¥å¤±æ•— ==========
      - name: ğŸ’¬ è©•è«–ï¼šç’°å¢ƒæª¢æŸ¥å¤±æ•—
        if: ${{ needs.environment-check.outputs.docker_status == 'failed' || needs.environment-check.outputs.compose_status == 'failed' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const errorType = "${{ needs.environment-check.outputs.error_message }}";
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) {
              console.log("é PR äº‹ä»¶ï¼Œè·³éè©•è«–");
              return;
            }
            
            const comment = `## âš ï¸ CI ç’°å¢ƒæª¢æŸ¥å¤±æ•—
            
            **éŒ¯èª¤é¡å‹**ï¼šç’°å¢ƒä¾è³´ç¼ºå¤±
            
            ### ğŸ” å¤±æ•—åŸå› 
            - Docker æˆ– Docker Compose æœªæ­£ç¢ºå®‰è£
            - Runner ç’°å¢ƒé…ç½®ä¸å®Œæ•´
            
            ### âœ… ä¿®æ­£æ­¥é©Ÿ
            
            **æœ¬åœ°ä¿®å¾©**ï¼š
            \`\`\`bash
            # 1. æª¢æŸ¥ç’°å¢ƒ
            bash scripts/check-env.sh
            
            # 2. å®‰è£ Dockerï¼ˆå¦‚éœ€è¦ï¼‰
            curl -fsSL https://get.docker.com | sh
            
            # 3. å®‰è£ Docker Compose
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            
            # 4. é©—è­‰å®‰è£
            docker --version
            docker-compose --version
            \`\`\`
            
            **Runner ä¿®å¾©**ï¼š
            - è«‹è¯ç¹« DevOps åœ˜éšŠæ›´æ–° GitHub Actions Runner ç’°å¢ƒ
            - æˆ–åœ¨ workflow ä¸­æ·»åŠ åˆå§‹åŒ–æ­¥é©Ÿ
            
            ### ğŸ“š ç›¸é—œæ–‡æª”
            - [Docker å®‰è£æŒ‡å—](https://docs.docker.com/get-docker/)
            - [Docker Compose å®‰è£æŒ‡å—](https://docs.docker.com/compose/install/)
            - [CI æ•…éšœæ’é™¤](./docs/ci-troubleshooting.md)
            
            ---
            *æ­¤è©•è«–ç”± CI è‡ªå‹•ç”Ÿæˆ | [æŸ¥çœ‹å®Œæ•´æ—¥èªŒ](${context.payload.pull_request?.html_url}/checks)*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      # ========== æƒ…æ³ 2ï¼šæ§‹å»ºå¤±æ•— ==========
      - name: ğŸ’¬ è©•è«–ï¼šæ§‹å»ºå¤±æ•—
        if: ${{ needs.build-and-test.result == 'failure' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) return;
            
            const comment = `## âŒ CI æ§‹å»ºå¤±æ•—
            
            **éšæ®µ**ï¼šDocker é¡åƒæ§‹å»º
            
            ### ğŸ” å¸¸è¦‹åŸå› 
            - Dockerfile èªæ³•éŒ¯èª¤
            - ä¾è³´åŒ…ç„¡æ³•ä¸‹è¼‰
            - è³‡æºä¸è¶³ï¼ˆç£ç›¤ç©ºé–“ã€å…§å­˜ï¼‰
            
            ### âœ… ä¿®æ­£æ­¥é©Ÿ
            
            **æœ¬åœ°èª¿è©¦**ï¼š
            \`\`\`bash
            # 1. æ¸…ç†èˆŠé¡åƒ
            docker system prune -a
            
            # 2. é‡æ–°æ§‹å»ºï¼ˆè©³ç´°è¼¸å‡ºï¼‰
            docker-compose build --no-cache --progress=plain
            
            # 3. æª¢æŸ¥ Dockerfile
            docker build --tag test-build . --progress=plain
            \`\`\`
            
            **å¸¸è¦‹ä¿®æ­£**ï¼š
            - æª¢æŸ¥ \`Dockerfile\` ä¸­çš„åŸºç¤é¡åƒç‰ˆæœ¬
            - é©—è­‰ \`.dockerignore\` é…ç½®
            - ç¢ºä¿æ‰€æœ‰ä¾è³´åœ¨ \`requirements.txt\` æˆ– \`package.json\` ä¸­
            
            ### ğŸ“Š è©³ç´°æ—¥èªŒ
            [æŸ¥çœ‹ Runner æ—¥èªŒ](${context.payload.pull_request?.html_url}/checks)
            
            ---
            *æ­¤è©•è«–ç”± CI è‡ªå‹•ç”Ÿæˆ*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      # ========== æƒ…æ³ 3ï¼šæ¸¬è©¦å¤±æ•— ==========
      - name: ğŸ’¬ è©•è«–ï¼šæ¸¬è©¦å¤±æ•—
        if: ${{ needs.build-and-test.result == 'failure' && needs.environment-check.outputs.docker_status == 'success' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) return;
            
            const comment = `## âŒ CI æ¸¬è©¦å¤±æ•—
            
            **éšæ®µ**ï¼šå–®å…ƒæ¸¬è©¦ / é›†æˆæ¸¬è©¦
            
            ### ğŸ” å¸¸è¦‹åŸå› 
            - æ–°å¢ä»£ç¢¼æœªé€šéç¾æœ‰æ¸¬è©¦
            - æ¸¬è©¦ç’°å¢ƒé…ç½®ä¸æ­£ç¢º
            - ä¾è³´ç‰ˆæœ¬ä¸å…¼å®¹
            
            ### âœ… ä¿®æ­£æ­¥é©Ÿ
            
            **æœ¬åœ°é‹è¡Œæ¸¬è©¦**ï¼š
            \`\`\`bash
            # 1. å®‰è£ä¾è³´
            npm install --workspaces
            
            # 2. é‹è¡Œæ¸¬è©¦
            npm test
            
            # 3. æŸ¥çœ‹ç‰¹å®šæœå‹™æ¸¬è©¦
            cd core/contracts/contracts-L1/contracts && npm test
            cd mcp-servers && npm test
            \`\`\`
            
            **èª¿è©¦æŠ€å·§**ï¼š
            - é‹è¡Œç‰¹å®šæ¸¬è©¦ï¼š\`npm test -- --testNamePattern="test name"\`
            - å•Ÿç”¨è©³ç´°è¼¸å‡ºï¼š\`npm test -- --verbose\`
            - æª¢æŸ¥æ¸¬è©¦è¦†è“‹ç‡ï¼š\`npm run test:coverage\`
            
            ### ğŸ“š ç›¸é—œè³‡æº
            - [æ¸¬è©¦ç·¨å¯«æŒ‡å—](./docs/testing-guide.md)
            - [æ¸¬è©¦è¦†è“‹ç‡è¦æ±‚](./docs/coverage-requirements.md)
            
            ---
            *æ­¤è©•è«–ç”± CI è‡ªå‹•ç”Ÿæˆ*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      # ========== æƒ…æ³ 4ï¼šæˆåŠŸ ==========
      - name: ğŸ’¬ è©•è«–ï¼šCI é€šé
        if: ${{ success() && needs.environment-check.outputs.docker_status == 'success' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) return;
            
            const comment = `## âœ… CI æª¢æŸ¥é€šé
            
            æ‰€æœ‰æª¢æŸ¥é …å·²æˆåŠŸå®Œæˆï¼š
            - âœ“ ç’°å¢ƒæª¢æŸ¥
            - âœ“ Docker æ§‹å»º
            - âœ“ å–®å…ƒæ¸¬è©¦
            - âœ“ é›†æˆæ¸¬è©¦
            
            æ­¤ PR å·²æº–å‚™å¥½é€²è¡Œä»£ç¢¼å¯©æŸ¥ã€‚
            
            ---
            *æ­¤è©•è«–ç”± CI è‡ªå‹•ç”Ÿæˆ*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      # ========== è‡ªå‹•æ¨™ç±¤æ©Ÿåˆ¶ ==========
      - name: ğŸ·ï¸ æ·»åŠ å¤±æ•—æ¨™ç±¤
        if: ${{ failure() }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) return;
            
            let labels = ['ci-failed'];
            
            if ("${{ needs.environment-check.outputs.docker_status }}" === "failed") {
              labels.push('env-error');
            }
            
            if ("${{ needs.build-and-test.result }}" === "failure") {
              labels.push('build-failed');
            }
            
            // å…ˆç²å–ç¾æœ‰æ¨™ç±¤ï¼Œé¿å…é‡è¤‡æ·»åŠ 
            try {
              const { data: existingLabels } = await github.rest.issues.listLabelsOnIssue({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              const existingLabelNames = existingLabels.map(l => l.name);
              labels = labels.filter(l => !existingLabelNames.includes(l));
              
              if (labels.length > 0) {
                await github.rest.issues.addLabels({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  labels: labels
                });
              }
            } catch (e) {
              console.log("æ¨™ç±¤æ“ä½œå¤±æ•—ï¼š", e.message);
            }
      
      - name: ğŸ·ï¸ ç§»é™¤å¤±æ•—æ¨™ç±¤ï¼ˆæˆåŠŸæ™‚ï¼‰
        if: ${{ success() && needs.environment-check.outputs.docker_status == 'success' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) return;
            
            const labelsToRemove = ['ci-failed', 'env-error', 'build-failed'];
            
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label
                });
              } catch (e) {
                console.log(`æ¨™ç±¤ ${label} ä¸å­˜åœ¨ï¼Œè·³éç§»é™¤`);
              }
            }
