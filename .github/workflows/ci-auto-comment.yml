---
name: CI è‡ªå‹•è©•è«–èˆ‡éŒ¯èª¤å°èˆªç³»çµ±

# æ³¨æ„ï¼šæ­¤ workflow å·²è¢« dynamic-ci-assistant.yml å–ä»£
# åƒ…åœ¨æ˜ç¢ºä¿®æ”¹ CI ç›¸é—œæ–‡ä»¶æ™‚è§¸ç™¼ï¼Œç”¨æ–¼é©—è­‰ CI å·¥å…·æœ¬èº«
on:
  pull_request:
    branches: [main, develop]
    paths:
      - '.github/workflows/ci-auto-comment.yml'
      - '.github/workflows/dynamic-ci-assistant.yml'
      - 'scripts/check-env.sh'
      - 'docs/ci-troubleshooting.md'
      - 'docs/CI_AUTO_COMMENT_SYSTEM.md'
  workflow_dispatch:
    inputs:
      test-mode:
        description: 'æ¸¬è©¦æ¨¡å¼ï¼ˆåƒ…é©—è­‰é…ç½®ï¼‰'
        required: false
        type: boolean
        default: true

env:
  DOCKER_COMPOSE_VERSION: "2.20.0"
  NODE_VERSION: "18"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ============================================
  # ç¬¬ä¸€éšæ®µï¼šç’°å¢ƒæª¢æŸ¥èˆ‡ä¾è³´é©—è­‰
  # ============================================
  environment-check:
    runs-on: ubuntu-latest
    outputs:
      docker_status: ${{ steps.docker-check.outputs.status }}
      compose_status: ${{ steps.compose-check.outputs.status }}
      error_message: ${{ steps.error-handler.outputs.message }}
      error_type: ${{ steps.error-handler.outputs.type }}
      solution: ${{ steps.error-handler.outputs.solution }}
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      # ========== Docker æª¢æŸ¥ ==========
      - name: ğŸ³ æª¢æŸ¥ Docker å®‰è£
        id: docker-check
        run: |
          if command -v docker &> /dev/null; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ“ Docker å·²å®‰è£ï¼š$(docker --version)"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âœ— Docker æœªå®‰è£"
            exit 1
          fi
        continue-on-error: true
      
      # ========== Docker Compose æª¢æŸ¥ ==========
      - name: ğŸ”§ æª¢æŸ¥ Docker Compose å®‰è£
        id: compose-check
        run: |
          if command -v docker-compose &> /dev/null || docker compose version &> /dev/null; then
            echo "status=success" >> $GITHUB_OUTPUT
            if command -v docker-compose &> /dev/null; then
              echo "âœ“ Docker Compose å·²å®‰è£ï¼š$(docker-compose --version)"
            else
              echo "âœ“ Docker Compose Plugin å·²å®‰è£ï¼š$(docker compose version)"
            fi
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âœ— Docker Compose æœªå®‰è£"
            exit 1
          fi
        continue-on-error: true
      
      # ========== éŒ¯èª¤è™•ç†èˆ‡åˆ†é¡ ==========
      - name: ğŸš¨ éŒ¯èª¤åˆ†é¡èˆ‡æ¶ˆæ¯ç”Ÿæˆ
        id: error-handler
        if: ${{ failure() }}
        run: |
          ERROR_TYPE="UNKNOWN"
          ERROR_MSG="CI æª¢æŸ¥å¤±æ•—"
          SOLUTION=""
          
          if [ "${{ steps.docker-check.outputs.status }}" = "failed" ]; then
            ERROR_TYPE="DOCKER_NOT_INSTALLED"
            ERROR_MSG="âŒ Docker æœªå®‰è£æˆ–ä¸å¯ç”¨"
            SOLUTION="è«‹åœ¨æœ¬åœ°åŸ·è¡Œï¼š\`curl -fsSL https://get.docker.com | sh\`"
          elif [ "${{ steps.compose-check.outputs.status }}" = "failed" ]; then
            ERROR_TYPE="DOCKER_COMPOSE_NOT_INSTALLED"
            ERROR_MSG="âŒ Docker Compose æœªå®‰è£æˆ–ç‰ˆæœ¬éèˆŠ"
            SOLUTION="è«‹åŸ·è¡Œï¼š\`sudo curl -L https://github.com/docker/compose/releases/download/v${DOCKER_COMPOSE_VERSION}/docker-compose-\$(uname -s)-\$(uname -m) -o /usr/local/bin/docker-compose && sudo chmod +x /usr/local/bin/docker-compose\`"
          fi
          
          echo "type=$ERROR_TYPE" >> $GITHUB_OUTPUT
          echo "message=$ERROR_MSG" >> $GITHUB_OUTPUT
          echo "solution=$SOLUTION" >> $GITHUB_OUTPUT
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âš ï¸ ç’°å¢ƒæª¢æŸ¥å¤±æ•—
          - **éŒ¯èª¤é¡å‹**ï¼š$ERROR_TYPE
          - **è©³æƒ…**ï¼š$ERROR_MSG
          - **ä¿®æ­£æ–¹æ¡ˆ**ï¼š$SOLUTION
          EOF
      
      # ========== GitHub Annotationï¼ˆç›´æ¥æ¨™è¨˜éŒ¯èª¤ï¼‰==========
      - name: ğŸ“ æ¨™è¨˜éŒ¯èª¤ä½ç½®ï¼ˆAnnotationï¼‰
        if: ${{ failure() }}
        run: |
          echo "::error title=ç’°å¢ƒæª¢æŸ¥å¤±æ•—::Docker æˆ– Docker Compose æœªå®‰è£ã€‚è«‹åƒè€ƒ PR è©•è«–ç²å–ä¿®æ­£æ–¹æ¡ˆã€‚"
          echo "::notice title=ä¿®æ­£æ­¥é©Ÿ::åŸ·è¡Œæœ¬åœ°ç’°å¢ƒæª¢æŸ¥ï¼šbash scripts/check-env.sh"

  # ============================================
  # ç¬¬äºŒéšæ®µï¼šé©—è­‰ CI å·¥å…·ï¼ˆè¼•é‡ç´šï¼Œä¸å¯¦éš›æ§‹å»º/æ¸¬è©¦ï¼‰
  # ============================================
  validate-ci-tools:
    needs: environment-check
    runs-on: ubuntu-latest
    if: ${{ needs.environment-check.outputs.docker_status == 'success' && needs.environment-check.outputs.compose_status == 'success' }}
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ” é©—è­‰ Docker Compose é…ç½®
        id: validate-compose
        shell: bash
        run: |
          # åƒ…é©—è­‰é…ç½®ï¼Œä¸å¯¦éš›æ§‹å»ºï¼ˆè¼•é‡ç´šï¼Œå¿«é€Ÿï¼‰
          if command -v docker-compose &> /dev/null; then
            COMPOSE_CMD="docker-compose"
          else
            COMPOSE_CMD="docker compose"
          fi
          
          echo "é©—è­‰ Docker Compose é…ç½®..."
          if $COMPOSE_CMD config > /dev/null 2>&1; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Docker Compose é…ç½®æœ‰æ•ˆ"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Docker Compose é…ç½®ç„¡æ•ˆ"
          fi
        continue-on-error: true
      
      - name: ğŸ” é©—è­‰ç’°å¢ƒæª¢æŸ¥è…³æœ¬
        id: validate-script
        shell: bash
        run: |
          echo "é©—è­‰ç’°å¢ƒæª¢æŸ¥è…³æœ¬..."
          if bash scripts/check-env.sh; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… ç’°å¢ƒæª¢æŸ¥è…³æœ¬åŸ·è¡ŒæˆåŠŸ"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ ç’°å¢ƒæª¢æŸ¥è…³æœ¬åŸ·è¡Œå¤±æ•—"
          fi
        continue-on-error: true
      
      - name: ğŸ“Š ç”Ÿæˆé©—è­‰å ±å‘Š
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ” CI å·¥å…·é©—è­‰ç‹€æ…‹
          - Docker Compose é…ç½®ï¼š${{ steps.validate-compose.outputs.status }}
          - ç’°å¢ƒæª¢æŸ¥è…³æœ¬ï¼š${{ steps.validate-script.outputs.status }}
          
          > æ³¨æ„ï¼šæ­¤ workflow åƒ…é©—è­‰ CI å·¥å…·æœ¬èº«ï¼Œä¸é‹è¡Œå®Œæ•´æ§‹å»º/æ¸¬è©¦
          > å®Œæ•´çš„ CI æª¢æŸ¥ç”±å…¶ä»–å°ˆé–€çš„ workflows è² è²¬
          > å‹•æ…‹äº’å‹•åŠŸèƒ½ç”± dynamic-ci-assistant.yml æä¾›
          EOF

  # ============================================
  # ç¬¬ä¸‰éšæ®µï¼šè‡ªå‹•è©•è«–ï¼ˆåƒ…ç”¨æ–¼ CI å·¥å…·è‡ªèº«çš„é©—è­‰ï¼‰
  # ============================================
  auto-comment:
    needs: [environment-check, validate-ci-tools]
    runs-on: ubuntu-latest
    if: always()  # ç„¡è«–æˆåŠŸæˆ–å¤±æ•—éƒ½åŸ·è¡Œ
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      # ========== æƒ…æ³ 1ï¼šç’°å¢ƒæª¢æŸ¥å¤±æ•— ==========
      - name: ğŸ’¬ è©•è«–ï¼šç’°å¢ƒæª¢æŸ¥å¤±æ•—
        if: ${{ needs.environment-check.outputs.docker_status == 'failed' || needs.environment-check.outputs.compose_status == 'failed' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const errorType = "${{ needs.environment-check.outputs.error_message }}";
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) {
              console.log("é PR äº‹ä»¶ï¼Œè·³éè©•è«–");
              return;
            }
            
            const comment = `## âš ï¸ CI ç’°å¢ƒæª¢æŸ¥å¤±æ•—
            
            **éŒ¯èª¤é¡å‹**ï¼šç’°å¢ƒä¾è³´ç¼ºå¤±
            
            ### ğŸ” å¤±æ•—åŸå› 
            - Docker æˆ– Docker Compose æœªæ­£ç¢ºå®‰è£
            - Runner ç’°å¢ƒé…ç½®ä¸å®Œæ•´
            
            ### âœ… ä¿®æ­£æ­¥é©Ÿ
            
            **æœ¬åœ°ä¿®å¾©**ï¼š
            \`\`\`bash
            # 1. æª¢æŸ¥ç’°å¢ƒ
            bash scripts/check-env.sh
            
            # 2. å®‰è£ Dockerï¼ˆå¦‚éœ€è¦ï¼‰
            curl -fsSL https://get.docker.com | sh
            
            # 3. å®‰è£ Docker Compose
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            
            # 4. é©—è­‰å®‰è£
            docker --version
            docker-compose --version
            \`\`\`
            
            **Runner ä¿®å¾©**ï¼š
            - è«‹è¯ç¹« DevOps åœ˜éšŠæ›´æ–° GitHub Actions Runner ç’°å¢ƒ
            - æˆ–åœ¨ workflow ä¸­æ·»åŠ åˆå§‹åŒ–æ­¥é©Ÿ
            
            ### ğŸ“š ç›¸é—œæ–‡æª”
            - [Docker å®‰è£æŒ‡å—](https://docs.docker.com/get-docker/)
            - [Docker Compose å®‰è£æŒ‡å—](https://docs.docker.com/compose/install/)
            - [CI æ•…éšœæ’é™¤](./docs/ci-troubleshooting.md)
            
            ---
            *æ­¤è©•è«–ç”± CI è‡ªå‹•ç”Ÿæˆ | [æŸ¥çœ‹å®Œæ•´æ—¥èªŒ](${context.payload.pull_request?.html_url}/checks)*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      # ========== æƒ…æ³ 2ï¼šCI å·¥å…·é©—è­‰å¤±æ•— ==========
      - name: ğŸ’¬ è©•è«–ï¼šCI å·¥å…·é©—è­‰å¤±æ•—
        if: ${{ needs.validate-ci-tools.result == 'failure' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) return;
            
            const comment = `## âš ï¸ CI å·¥å…·é©—è­‰å¤±æ•—
            
            **éšæ®µ**ï¼šCI å·¥å…·è‡ªèº«é©—è­‰
            
            ### ğŸ” å¸¸è¦‹åŸå› 
            - Docker Compose é…ç½®èªæ³•éŒ¯èª¤
            - ç’°å¢ƒæª¢æŸ¥è…³æœ¬å•é¡Œ
            - CI é…ç½®æ–‡ä»¶æ ¼å¼éŒ¯èª¤
            
            ### âœ… ä¿®æ­£æ­¥é©Ÿ
            
            **æœ¬åœ°é©—è­‰**ï¼š
            \`\`\`bash
            # 1. é©—è­‰ Docker Compose é…ç½®
            docker-compose config
            
            # 2. æ¸¬è©¦ç’°å¢ƒæª¢æŸ¥è…³æœ¬
            bash scripts/check-env.sh
            
            # 3. æª¢æŸ¥ YAML èªæ³•
            yamllint .github/workflows/
            \`\`\`
            
            ### ğŸ“š ç›¸é—œæ–‡æª”
            - [CI ç³»çµ±æ–‡æª”](./docs/CI_AUTO_COMMENT_SYSTEM.md)
            - [æ•…éšœæ’é™¤æŒ‡å—](./docs/ci-troubleshooting.md)
            
            ---
            *æ­¤è©•è«–ç”± CI å·¥å…·é©—è­‰ç³»çµ±è‡ªå‹•ç”Ÿæˆ*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      

      
      # ========== æƒ…æ³ 3ï¼šCI å·¥å…·é©—è­‰æˆåŠŸ ==========
      - name: ğŸ’¬ è©•è«–ï¼šCI å·¥å…·é©—è­‰æˆåŠŸ
        if: ${{ success() && needs.environment-check.outputs.docker_status == 'success' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) return;
            
            const comment = `## âœ… CI å·¥å…·é©—è­‰é€šé
            
            CI å·¥å…·ç›¸é—œæ–‡ä»¶çš„é©—è­‰å·²æˆåŠŸå®Œæˆï¼š
            - âœ“ ç’°å¢ƒæª¢æŸ¥
            - âœ“ Docker Compose é…ç½®é©—è­‰
            - âœ“ ç’°å¢ƒæª¢æŸ¥è…³æœ¬é©—è­‰
            
            ### ğŸ“Œ æ³¨æ„
            æ­¤ PR ä¿®æ”¹äº† CI ç›¸é—œæ–‡ä»¶ã€‚å®Œæ•´çš„é …ç›® CI æª¢æŸ¥ç”±å…¶ä»–å°ˆé–€çš„ workflows åŸ·è¡Œï¼š
            - Core Services CI
            - Integration & Deployment
            - å…¶ä»–å°ˆæ¡ˆç‰¹å®šçš„ CI workflows
            
            ### ğŸ¤– å‹•æ…‹äº’å‹• CI
            æ–°çš„**å‹•æ…‹ CI åŠ©æ‰‹**å°‡ç›£æ§æ‰€æœ‰ CI workflowsï¼Œä¸¦åœ¨å¤±æ•—æ™‚æä¾›æ™ºèƒ½è¨ºæ–·å’Œäº’å‹•å¼åé¥‹ã€‚
            
            ---
            *æ­¤è©•è«–ç”± CI å·¥å…·é©—è­‰ç³»çµ±è‡ªå‹•ç”Ÿæˆ*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      # ========== è‡ªå‹•æ¨™ç±¤æ©Ÿåˆ¶ ==========
      - name: ğŸ·ï¸ æ·»åŠ å¤±æ•—æ¨™ç±¤
        if: ${{ failure() }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) return;
            
            let labels = ['ci-failed'];
            
            if ("${{ needs.environment-check.outputs.docker_status }}" === "failed") {
              labels.push('env-error');
            }
            
            if ("${{ needs.validate-ci-tools.result }}" === "failure") {
              labels.push('ci-tools-failed');
            }
            
            // å…ˆç²å–ç¾æœ‰æ¨™ç±¤ï¼Œé¿å…é‡è¤‡æ·»åŠ 
            try {
              const { data: existingLabels } = await github.rest.issues.listLabelsOnIssue({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              const existingLabelNames = existingLabels.map(l => l.name);
              labels = labels.filter(l => !existingLabelNames.includes(l));
              
              if (labels.length > 0) {
                await github.rest.issues.addLabels({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  labels: labels
                });
              }
            } catch (e) {
              console.log("æ¨™ç±¤æ“ä½œå¤±æ•—ï¼š", e.message);
            }
      
      - name: ğŸ·ï¸ ç§»é™¤å¤±æ•—æ¨™ç±¤ï¼ˆæˆåŠŸæ™‚ï¼‰
        if: ${{ success() && needs.environment-check.outputs.docker_status == 'success' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            
            if (!prNumber) return;
            
            const labelsToRemove = ['ci-failed', 'env-error', 'build-failed'];
            
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label
                });
              } catch (e) {
                console.log(`æ¨™ç±¤ ${label} ä¸å­˜åœ¨ï¼Œè·³éç§»é™¤`);
              }
            }
