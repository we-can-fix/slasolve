name: Monorepo CI Dispatcher

"on":
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      mcp-servers: ${{ steps.filter.outputs.mcp-servers }}
      contracts: ${{ steps.filter.outputs.contracts }}
      advanced-system: ${{ steps.filter.outputs.advanced-system }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ðŸ” Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            mcp-servers:
              - 'mcp-servers/**'
            contracts:
              - 'core/contracts/contracts-L1/contracts/**'
            advanced-system:
              - 'advanced-system-src/**'

  ci-mcp-servers:
    needs: detect-changes
    if: needs.detect-changes.outputs.mcp-servers == 'true'
    uses: ./.github/workflows/reusable-ci.yml
    with:
      working-directory: mcp-servers
      service-name: mcp-servers
      node-version: '18'
      enable-docker-build: false
      enable-sbom: true

  ci-contracts:
    needs: detect-changes
    if: needs.detect-changes.outputs.contracts == 'true'
    uses: ./.github/workflows/reusable-ci.yml
    with:
      working-directory: core/contracts/contracts-L1/contracts
      service-name: contracts-service
      node-version: '18'
      enable-docker-build: true
      enable-sbom: true

  ci-advanced-system:
    needs: detect-changes
    if: needs.detect-changes.outputs.advanced-system == 'true'
    uses: ./.github/workflows/reusable-ci.yml
    with:
      working-directory: advanced-system-src
      service-name: advanced-system
      node-version: '18'
      enable-docker-build: false
      enable-sbom: true

  summary:
    needs: [detect-changes, ci-mcp-servers, ci-contracts, ci-advanced-system]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š CI Summary
        run: |
          echo "## ðŸŽ¯ Monorepo CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å­å°ˆæ¡ˆ | ç‹€æ…‹ | è®Šæ›´æª¢æ¸¬ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| MCP Servers | ${{ needs.ci-mcp-servers.result || 'skipped' }} | ${{ needs.detect-changes.outputs.mcp-servers }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Contracts | ${{ needs.ci-contracts.result || 'skipped' }} | ${{ needs.detect-changes.outputs.contracts }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Advanced System | ${{ needs.ci-advanced-system.result || 'skipped' }} | ${{ needs.detect-changes.outputs.advanced-system }} |" >> $GITHUB_STEP_SUMMARY
