---
name: å‹•æ…‹äº’å‹• CI åŠ©æ‰‹

# æ­¤ workflow ç›£æ§å…¶ä»– CI workflowsï¼Œæä¾›æ™ºèƒ½åˆ†æå’Œäº’å‹•å¼åé¥‹
# ğŸ’¡ è¨­è¨ˆç†å¿µï¼šå°ˆæ³¨æ–¼å¤±æ•—è¨ºæ–·å’Œäº’å‹•åé¥‹ï¼Œä¸ç™¼å¸ƒæˆåŠŸé€šçŸ¥ï¼ˆé¿å…è³‡æºæµªè²»ï¼‰
# ğŸ” å¤±æ•—æ™‚ï¼šæä¾›æ™ºèƒ½è¨ºæ–·ã€ä¿®å¾©å»ºè­°ã€äº’å‹•å‘½ä»¤
# âœ… æˆåŠŸæ™‚ï¼šåƒ…æ¸…ç†æ¨™ç±¤ï¼Œä¸ç™¼å¸ƒè©•è«–
on:
  workflow_run:
    workflows:
      - "Core Services CI"
      - "Integration & Deployment"
      - "Auto-Fix Bot"
      - "Compliance Report Generator"
      - "Stage 1: Basic CI"
      - "Language Compliance Check"
      - "CodeQL Advanced Security Scan"
      - "Phase 1 Infrastructure Integration"
    types:
      - completed
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: read
  actions: read

jobs:
  # ============================================
  # æ™ºèƒ½ CI ç‹€æ…‹åˆ†æ
  # ============================================
  analyze-ci-status:
    name: ğŸ¤– æ™ºèƒ½åˆ†æ CI ç‹€æ…‹
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' || github.event_name == 'pull_request'
    outputs:
      has_failures: ${{ steps.check-status.outputs.has_failures || steps.set-defaults.outputs.has_failures }}
      failed_workflows: ${{ steps.check-status.outputs.failed_workflows || steps.set-defaults.outputs.failed_workflows }}
      pr_number: ${{ steps.get-pr.outputs.pr_number }}
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ” ç²å– PR ç·¨è™Ÿ
        id: get-pr
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            let prNumber = null;
            
            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'workflow_run') {
              // å¾ workflow_run ç²å–é—œè¯çš„ PR
              const pulls = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
                state: 'open'
              });
              
              if (pulls.data.length > 0) {
                prNumber = pulls.data[0].number;
              }
            }
            
            console.log(`PR Number: ${prNumber}`);
            core.setOutput('pr_number', prNumber);
            return prNumber;
      
      - name: ğŸ”§ è¨­å®šé è¨­è¼¸å‡ºå€¼
        id: set-defaults
        if: steps.get-pr.outputs.pr_number == ''
        run: |
          echo "has_failures=false" >> $GITHUB_OUTPUT
          echo "failed_workflows=[]" >> $GITHUB_OUTPUT
          echo "No PR number found, setting default outputs"
      
      - name: ğŸ” æª¢æŸ¥ CI ç‹€æ…‹
        id: check-status
        if: steps.get-pr.outputs.pr_number
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = ${{ steps.get-pr.outputs.pr_number }};
            
            // ç²å– PR çš„æ‰€æœ‰ check runs
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha,
              per_page: 100
            });
            
            // åˆ†æå¤±æ•—çš„ workflows
            const failedChecks = checks.check_runs.filter(check => 
              check.conclusion === 'failure' || check.conclusion === 'timed_out'
            );
            
            const hasFailures = failedChecks.length > 0;
            const failedWorkflows = failedChecks.map(check => ({
              name: check.name,
              conclusion: check.conclusion,
              html_url: check.html_url,
              started_at: check.started_at,
              completed_at: check.completed_at
            }));
            
            console.log(`Has failures: ${hasFailures}`);
            console.log(`Failed workflows: ${JSON.stringify(failedWorkflows, null, 2)}`);
            
            core.setOutput('has_failures', hasFailures);
            core.setOutput('failed_workflows', JSON.stringify(failedWorkflows));
            
            // ç”Ÿæˆæ‘˜è¦
            if (hasFailures) {
              core.summary
                .addHeading('âš ï¸ CI æª¢æŸ¥å¤±æ•—æ‘˜è¦', 2)
                .addTable([
                  [{data: 'Workflow', header: true}, {data: 'ç‹€æ…‹', header: true}, {data: 'é€£çµ', header: true}],
                  ...failedWorkflows.map(w => [
                    w.name,
                    w.conclusion === 'failure' ? 'âŒ å¤±æ•—' : 'â±ï¸ è¶…æ™‚',
                    `[æŸ¥çœ‹æ—¥èªŒ](${w.html_url})`
                  ])
                ])
                .write();
            }

  # ============================================
  # æ™ºèƒ½éŒ¯èª¤è¨ºæ–·èˆ‡åˆ†æ
  # ============================================
  diagnose-failures:
    name: ğŸ”¬ è¨ºæ–·å¤±æ•—åŸå› 
    needs: analyze-ci-status
    runs-on: ubuntu-latest
    if: needs.analyze-ci-status.outputs.has_failures == 'true' && needs.analyze-ci-status.outputs.pr_number != ''
    outputs:
      diagnosis_report: ${{ steps.diagnose.outputs.report }}
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ”¬ åˆ†æå¤±æ•—åŸå› 
        id: diagnose
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const failedWorkflows = JSON.parse('${{ needs.analyze-ci-status.outputs.failed_workflows }}');
            const prNumber = ${{ needs.analyze-ci-status.outputs.pr_number }};
            
            let diagnosis = {
              summary: '',
              details: [],
              recommendations: [],
              quickFixes: []
            };
            
            // æ™ºèƒ½è¨ºæ–·é‚è¼¯
            for (const workflow of failedWorkflows) {
              const workflowName = workflow.name.toLowerCase();
              
              if (workflowName.includes('docker') || workflowName.includes('build')) {
                diagnosis.details.push({
                  type: 'build_failure',
                  workflow: workflow.name,
                  message: 'Docker æ§‹å»ºå¤±æ•—',
                  possibleCauses: [
                    'Dockerfile èªæ³•éŒ¯èª¤',
                    'ä¾è³´åŒ…ç„¡æ³•ä¸‹è¼‰',
                    'ç£ç›¤ç©ºé–“ä¸è¶³',
                    'åŸºç¤é¡åƒä¸å¯ç”¨'
                  ]
                });
                
                diagnosis.recommendations.push({
                  title: `ä¿®å¾© ${workflow.name} æ§‹å»ºå•é¡Œ`,
                  steps: [
                    'æœ¬åœ°åŸ·è¡Œï¼š`docker-compose build --no-cache --progress=plain`',
                    'æª¢æŸ¥ Dockerfile èªæ³•',
                    'é©—è­‰åŸºç¤é¡åƒç‰ˆæœ¬',
                    'æ¸…ç†ç£ç›¤ç©ºé–“ï¼š`docker system prune -a`'
                  ],
                  urgency: 'high'
                });
              } else if (workflowName.includes('test')) {
                diagnosis.details.push({
                  type: 'test_failure',
                  workflow: workflow.name,
                  message: 'æ¸¬è©¦åŸ·è¡Œå¤±æ•—',
                  possibleCauses: [
                    'æ–°å¢ä»£ç¢¼ç ´å£ç¾æœ‰æ¸¬è©¦',
                    'æ¸¬è©¦ç’°å¢ƒé…ç½®å•é¡Œ',
                    'ä¾è³´ç‰ˆæœ¬ä¸å…¼å®¹',
                    'æ¸¬è©¦æ•¸æ“šå•é¡Œ'
                  ]
                });
                
                diagnosis.recommendations.push({
                  title: `ä¿®å¾© ${workflow.name} æ¸¬è©¦å•é¡Œ`,
                  steps: [
                    'æœ¬åœ°åŸ·è¡Œæ¸¬è©¦ï¼š`npm test`',
                    'æŸ¥çœ‹æ¸¬è©¦æ—¥èªŒæ‰¾å‡ºå¤±æ•—çš„å…·é«”æ¸¬è©¦',
                    'æª¢æŸ¥æœ€è¿‘çš„ä»£ç¢¼è®Šæ›´',
                    'é©—è­‰æ¸¬è©¦ç’°å¢ƒé…ç½®'
                  ],
                  urgency: 'high'
                });
              } else if (workflowName.includes('deploy') || workflowName.includes('integration')) {
                diagnosis.details.push({
                  type: 'deployment_failure',
                  workflow: workflow.name,
                  message: 'éƒ¨ç½²æˆ–æ•´åˆå¤±æ•—',
                  possibleCauses: [
                    'ç’°å¢ƒè®Šæ•¸é…ç½®éŒ¯èª¤',
                    'æœå‹™ä¾è³´å•é¡Œ',
                    'æ¬Šé™ä¸è¶³',
                    'ç¶²è·¯é€£ç·šå•é¡Œ'
                  ]
                });
                
                diagnosis.recommendations.push({
                  title: `ä¿®å¾© ${workflow.name} éƒ¨ç½²å•é¡Œ`,
                  steps: [
                    'æª¢æŸ¥ç’°å¢ƒè®Šæ•¸é…ç½®',
                    'é©—è­‰æœå‹™ä¾è³´ç‹€æ…‹',
                    'ç¢ºèªéƒ¨ç½²æ¬Šé™',
                    'æŸ¥çœ‹ç¶²è·¯é€£ç·šæ—¥èªŒ'
                  ],
                  urgency: 'medium'
                });
              } else {
                diagnosis.details.push({
                  type: 'unknown_failure',
                  workflow: workflow.name,
                  message: 'CI æª¢æŸ¥å¤±æ•—',
                  possibleCauses: [
                    'æŸ¥çœ‹è©³ç´°æ—¥èªŒä»¥äº†è§£å…·é«”åŸå› '
                  ]
                });
                
                diagnosis.recommendations.push({
                  title: `æª¢æŸ¥ ${workflow.name} å¤±æ•—æ—¥èªŒ`,
                  steps: [
                    `[æŸ¥çœ‹å®Œæ•´æ—¥èªŒ](${workflow.html_url})`,
                    'åˆ†æéŒ¯èª¤è¨Šæ¯',
                    'åƒè€ƒ CI æ•…éšœæ’é™¤æ–‡æª”'
                  ],
                  urgency: 'medium'
                });
              }
            }
            
            // æ·»åŠ å¿«é€Ÿä¿®å¾©å»ºè­°
            diagnosis.quickFixes = [
              {
                title: 'ğŸ”§ é‹è¡Œç’°å¢ƒæª¢æŸ¥',
                command: 'bash scripts/check-env.sh',
                description: 'æª¢æŸ¥æœ¬åœ°é–‹ç™¼ç’°å¢ƒé…ç½®'
              },
              {
                title: 'ğŸ§¹ æ¸…ç† Docker è³‡æº',
                command: 'docker system prune -a',
                description: 'é‡‹æ”¾ç£ç›¤ç©ºé–“'
              },
              {
                title: 'ğŸ“š æŸ¥çœ‹æ•…éšœæ’é™¤æ–‡æª”',
                link: './docs/ci-troubleshooting.md',
                description: 'è©³ç´°çš„éŒ¯èª¤è§£æ±ºæ–¹æ¡ˆ'
              }
            ];
            
            diagnosis.summary = `ç™¼ç¾ ${failedWorkflows.length} å€‹ CI æª¢æŸ¥å¤±æ•—`;
            
            core.setOutput('report', JSON.stringify(diagnosis));
            return diagnosis;

  # ============================================
  # äº’å‹•å¼ PR è©•è«–
  # ============================================
  interactive-comment:
    name: ğŸ’¬ ç”Ÿæˆäº’å‹•å¼è©•è«–
    needs: [analyze-ci-status, diagnose-failures]
    runs-on: ubuntu-latest
    if: needs.analyze-ci-status.outputs.has_failures == 'true' && needs.analyze-ci-status.outputs.pr_number != ''
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ’¬ ç™¼å¸ƒæ™ºèƒ½è¨ºæ–·è©•è«–
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = ${{ needs.analyze-ci-status.outputs.pr_number }};
            const diagnosis = JSON.parse('${{ needs.diagnose-failures.outputs.diagnosis_report }}');
            const failedWorkflows = JSON.parse('${{ needs.analyze-ci-status.outputs.failed_workflows }}');
            
            // ç”Ÿæˆäº’å‹•å¼è©•è«–
            let comment = `## ğŸ¤– å‹•æ…‹ CI åŠ©æ‰‹ - æ™ºèƒ½è¨ºæ–·å ±å‘Š
            
            ${diagnosis.summary}
            
            ---
            
            ### ğŸ“Š å¤±æ•—çš„ CI æª¢æŸ¥
            
            | Workflow | ç‹€æ…‹ | æ—¥èªŒé€£çµ |
            |----------|------|---------|
            `;
            
            for (const workflow of failedWorkflows) {
              const status = workflow.conclusion === 'failure' ? 'âŒ å¤±æ•—' : 'â±ï¸ è¶…æ™‚';
              comment += `| ${workflow.name} | ${status} | [æŸ¥çœ‹æ—¥èªŒ](${workflow.html_url}) |\n`;
            }
            
            comment += `\n---\n\n### ğŸ”¬ æ™ºèƒ½è¨ºæ–·åˆ†æ\n\n`;
            
            for (const detail of diagnosis.details) {
              comment += `#### ${detail.workflow}\n\n`;
              comment += `**å•é¡Œé¡å‹**: ${detail.message}\n\n`;
              comment += `**å¯èƒ½åŸå› **:\n`;
              for (const cause of detail.possibleCauses) {
                comment += `- ${cause}\n`;
              }
              comment += `\n`;
            }
            
            comment += `---\n\n### âœ… ä¿®å¾©å»ºè­°\n\n`;
            
            for (const rec of diagnosis.recommendations) {
              const urgencyEmoji = rec.urgency === 'high' ? 'ğŸ”´' : 'ğŸŸ¡';
              comment += `${urgencyEmoji} **${rec.title}**\n\n`;
              comment += `\`\`\`bash\n`;
              for (const step of rec.steps) {
                comment += `${step}\n`;
              }
              comment += `\`\`\`\n\n`;
            }
            
            comment += `---\n\n### âš¡ å¿«é€Ÿä¿®å¾©\n\n`;
            
            for (const fix of diagnosis.quickFixes) {
              comment += `**${fix.title}**\n`;
              if (fix.command) {
                comment += `\`\`\`bash\n${fix.command}\n\`\`\`\n`;
              }
              if (fix.link) {
                comment += `ğŸ“– [${fix.description}](${fix.link})\n`;
              } else {
                comment += `${fix.description}\n`;
              }
              comment += `\n`;
            }
            
            comment += `---\n\n### ğŸ¤ éœ€è¦å¹«åŠ©ï¼Ÿ\n\n`;
            comment += `- ğŸ’¬ åœ¨æ­¤è©•è«–å›è¦† \`@copilot å¹«æˆ‘åˆ†æ\` ç²å–æ›´è©³ç´°çš„å”åŠ©\n`;
            comment += `- ğŸ“š æŸ¥çœ‹ [CI æ•…éšœæ’é™¤æ–‡æª”](./docs/ci-troubleshooting.md)\n`;
            comment += `- ğŸ”§ åŸ·è¡Œ \`bash scripts/check-env.sh\` æª¢æŸ¥æœ¬åœ°ç’°å¢ƒ\n\n`;
            comment += `*æ­¤è©•è«–ç”±å‹•æ…‹ CI åŠ©æ‰‹è‡ªå‹•ç”Ÿæˆ | æœ€å¾Œæ›´æ–°: ${new Date().toISOString()}*`;
            
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„è©•è«–
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComments = comments.filter(c => 
              c.user.type === 'Bot' && c.body.includes('å‹•æ…‹ CI åŠ©æ‰‹')
            );
            
            if (botComments.length > 0) {
              // æ›´æ–°ç¾æœ‰è©•è«–
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComments[0].id,
                body: comment
              });
              console.log('Updated existing comment');
            } else {
              // å‰µå»ºæ–°è©•è«–
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              console.log('Created new comment');
            }
      
      - name: ğŸ·ï¸ æ›´æ–° PR æ¨™ç±¤
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = ${{ needs.analyze-ci-status.outputs.pr_number }};
            const diagnosis = JSON.parse('${{ needs.diagnose-failures.outputs.diagnosis_report }}');
            
            // æ ¹æ“šè¨ºæ–·çµæœæ·»åŠ æ¨™ç±¤
            let labels = ['ci-needs-attention'];
            
            for (const detail of diagnosis.details) {
              if (detail.type === 'build_failure') {
                labels.push('build-failed');
              } else if (detail.type === 'test_failure') {
                labels.push('test-failed');
              } else if (detail.type === 'deployment_failure') {
                labels.push('deployment-failed');
              }
            }
            
            // å»é‡
            labels = [...new Set(labels)];
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: labels
              });
              console.log(`Added labels: ${labels.join(', ')}`);
            } catch (error) {
              console.log(`Failed to add labels: ${error.message}`);
            }

  # ============================================
  # äº’å‹•å¼å›æ‡‰è™•ç†
  # ============================================
  handle-interaction:
    name: ğŸ—£ï¸ è™•ç†é–‹ç™¼è€…äº’å‹•
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@copilot')
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: ğŸ—£ï¸ è§£æé–‹ç™¼è€…è«‹æ±‚
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const comment = context.payload.comment.body;
            const prNumber = context.issue.number;
            
            let response = '';
            
            if (comment.includes('å¹«æˆ‘åˆ†æ') || comment.includes('åˆ†æ')) {
              response = `## ğŸ” æ·±åº¦åˆ†æä¸­...\n\n`;
              response += `æˆ‘æ­£åœ¨åˆ†ææ‚¨çš„ PRï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“ã€‚\n\n`;
              response += `åˆ†æé …ç›®ï¼š\n`;
              response += `- âœ… CI workflow ç‹€æ…‹\n`;
              response += `- âœ… éŒ¯èª¤æ—¥èªŒæ¨¡å¼\n`;
              response += `- âœ… ä»£ç¢¼è®Šæ›´å½±éŸ¿\n`;
              response += `- âœ… ç›¸ä¼¼å•é¡Œæ­·å²\n\n`;
              response += `è«‹ç¨å€™...`;
            } else if (comment.includes('ç’°å¢ƒ') || comment.includes('check-env')) {
              response = `## ğŸ”§ ç’°å¢ƒæª¢æŸ¥æŒ‡å—\n\n`;
              response += `è«‹åœ¨æœ¬åœ°åŸ·è¡Œä»¥ä¸‹å‘½ä»¤æª¢æŸ¥æ‚¨çš„é–‹ç™¼ç’°å¢ƒï¼š\n\n`;
              response += `\`\`\`bash\nbash scripts/check-env.sh\n\`\`\`\n\n`;
              response += `é€™å°‡æª¢æŸ¥ï¼š\n`;
              response += `- âœ… Docker å®‰è£\n`;
              response += `- âœ… Docker Compose ç‰ˆæœ¬\n`;
              response += `- âœ… Node.js ç‰ˆæœ¬ (â‰¥18)\n`;
              response += `- âœ… Git é…ç½®\n`;
              response += `- âœ… ç£ç›¤ç©ºé–“\n\n`;
              response += `å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œè…³æœ¬æœƒæä¾›å…·é«”çš„å®‰è£æŒ‡å—ã€‚`;
            } else if (comment.includes('æ–‡æª”') || comment.includes('documentation')) {
              response = `## ğŸ“š ç›¸é—œæ–‡æª”\n\n`;
              response += `ä»¥ä¸‹æ–‡æª”å¯èƒ½å°æ‚¨æœ‰å¹«åŠ©ï¼š\n\n`;
              response += `- [CI è‡ªå‹•è©•è«–ç³»çµ±æ–‡æª”](./docs/CI_AUTO_COMMENT_SYSTEM.md)\n`;
              response += `- [CI æ•…éšœæ’é™¤ Runbook](./docs/ci-troubleshooting.md)\n`;
              response += `- [README - CI æ•…éšœæ’é™¤](./README.md#-ci-æ•…éšœæ’é™¤)\n\n`;
              response += `å¦‚éœ€æ›´å…·é«”çš„å¹«åŠ©ï¼Œè«‹æè¿°æ‚¨é‡åˆ°çš„å•é¡Œã€‚`;
            } else {
              response = `## ğŸ‘‹ æ‚¨å¥½ï¼\n\n`;
              response += `æˆ‘æ˜¯å‹•æ…‹ CI åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¹«æ‚¨ï¼š\n\n`;
              response += `- ğŸ” **åˆ†æ CI å¤±æ•—åŸå› ** - å›è¦† \`@copilot å¹«æˆ‘åˆ†æ\`\n`;
              response += `- ğŸ”§ **ç’°å¢ƒæª¢æŸ¥æŒ‡å°** - å›è¦† \`@copilot ç’°å¢ƒæª¢æŸ¥\`\n`;
              response += `- ğŸ“š **æŸ¥æ‰¾ç›¸é—œæ–‡æª”** - å›è¦† \`@copilot æ–‡æª”\`\n\n`;
              response += `æœ‰ä»€éº¼å¯ä»¥å¹«åŠ©æ‚¨çš„å—ï¼Ÿ`;
            }
            
            // ç™¼å¸ƒå›æ‡‰
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: response
            });

  # ============================================
  # æˆåŠŸæ™‚æ¸…ç†æ¨™ç±¤ï¼ˆä¸ç™¼å¸ƒè©•è«–ï¼‰
  # ============================================
  # æ³¨æ„ï¼šæ ¹æ“šç”¨æˆ¶è¦æ±‚ï¼ŒæˆåŠŸæ™‚åƒ…æ¸…ç†æ¨™ç±¤ï¼Œä¸ç™¼å¸ƒè©•è«–
  # åŸå› ï¼šæˆåŠŸé€šçŸ¥ä¸å…·æœ‰æ„ç¾©ä¸”æµªè²»è³‡æºï¼Œæ‡‰å°ˆæ³¨æ–¼å¤±æ•—è¨ºæ–·å’Œäº’å‹•åé¥‹
  cleanup-on-success:
    name: ğŸ§¹ æ¸…ç†æˆåŠŸå¾Œçš„æ¨™ç±¤
    needs: analyze-ci-status
    runs-on: ubuntu-latest
    if: needs.analyze-ci-status.outputs.has_failures == 'false' && needs.analyze-ci-status.outputs.pr_number != ''
    
    steps:
      - name: ğŸ§¹ ç§»é™¤å¤±æ•—æ¨™ç±¤
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = ${{ needs.analyze-ci-status.outputs.pr_number }};
            const labelsToRemove = [
              'ci-needs-attention',
              'build-failed',
              'test-failed',
              'deployment-failed',
              'ci-failed',
              'env-error'
            ];
            
            console.log('âœ… CI æª¢æŸ¥æˆåŠŸï¼Œæ¸…ç†å¤±æ•—æ¨™ç±¤ï¼ˆä¸ç™¼å¸ƒæˆåŠŸè©•è«–ï¼‰');
            
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label
                });
                console.log(`âœ… å·²ç§»é™¤æ¨™ç±¤: ${label}`);
              } catch (error) {
                // æ¨™ç±¤ä¸å­˜åœ¨ï¼Œå¿½ç•¥éŒ¯èª¤
                console.log(`â„¹ï¸ æ¨™ç±¤ ${label} ä¸å­˜åœ¨ï¼Œè·³é`);
              }
            }
            
            console.log('âœ… æ¨™ç±¤æ¸…ç†å®Œæˆã€‚å°ˆæ³¨æ–¼å¤±æ•—è¨ºæ–·ï¼Œä¸ç™¼å¸ƒæˆåŠŸé€šçŸ¥ã€‚');
