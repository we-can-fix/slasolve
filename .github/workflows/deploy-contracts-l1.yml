name: Deploy Contracts L1 Service

on:
  push:
    branches: [main]
    paths:
      - 'core/contracts/contracts-L1/contracts/**'
  pull_request:
    paths:
      - 'core/contracts/contracts-L1/contracts/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  # ==================== å»ºç½®èˆ‡æ¸¬è©¦ ====================
  build-and-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@bfc4944b43a5d84377eca3cf6ab5b7992ba61923 # v5.0.0
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: core/contracts/contracts-L1/contracts/package-lock.json
      
      - name: ðŸ“¦ Install Dependencies
        working-directory: core/contracts/contracts-L1/contracts
        run: npm ci
      
      - name: ðŸ” Type Check
        working-directory: core/contracts/contracts-L1/contracts
        run: npm run typecheck
      
      - name: ðŸŽ¨ Lint Code
        working-directory: core/contracts/contracts-L1/contracts
        run: npm run lint
      
      - name: ðŸ§ª Run Tests
        working-directory: core/contracts/contracts-L1/contracts
        run: npm run test
      
      - name: ðŸ“¦ Build Application
        working-directory: core/contracts/contracts-L1/contracts
        run: npm run build
      
      - name: ðŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: contracts-l1-dist
          path: core/contracts/contracts-L1/contracts/dist/
          retention-days: 7

  # ==================== SBOM ç”Ÿæˆ ====================
  generate-sbom:
    name: ðŸ“‹ Generate SBOM
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@bfc4944b43a5d84377eca3cf6ab5b7992ba61923 # v5.0.0
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install Dependencies
        working-directory: core/contracts/contracts-L1/contracts
        run: npm ci
      
      - name: ðŸ“‹ Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: core/contracts/contracts-L1/contracts
          artifact-name: contracts-l1-sbom.spdx.json
          output-file: contracts-l1-sbom.spdx.json
          format: spdx-json
      
      - name: ðŸ“¤ Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: contracts-l1-sbom
          path: contracts-l1-sbom.spdx.json
          retention-days: 90

  # ==================== Docker å»ºç½® ====================
  build-docker:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      
      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“ Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/contracts-l1
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: ðŸ”¨ Build and Push Docker Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: core/contracts/contracts-L1/contracts
          file: core/contracts/contracts-L1/contracts/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
      
      - name: ðŸ“ Output Image Digest
        run: echo "Image digest::" ${{ steps.build.outputs.digest }}

  # ==================== å®‰å…¨æŽƒæ ====================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ” Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}/contracts-l1:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: ðŸ“¤ Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ==================== éƒ¨ç½²åˆ° Staging ====================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-docker, security-scan]
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://contracts-l1-staging.slasolve.com
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      
      - name: ðŸš€ Deploy to Staging
        run: |
          echo "ðŸš€ Deploying Contracts L1 to Staging..."
          echo "Image: ghcr.io/${{ github.repository }}/contracts-l1:${{ github.sha }}"
          # å¯¦éš›éƒ¨ç½²å‘½ä»¤å°‡æ ¹æ“šæ‚¨çš„åŸºç¤Žè¨­æ–½è€Œå®š
          # ä¾‹å¦‚: kubectl set image deployment/contracts-l1 contracts-l1=ghcr.io/${{ github.repository }}/contracts-l1:${{ github.sha }}
      
      - name: âœ… Verify Deployment
        run: |
          echo "âœ… Verifying deployment..."
          # å¥åº·æª¢æŸ¥
          # curl -f https://contracts-l1-staging.slasolve.com/healthz || exit 1
      
      - name: ðŸ“Š Create Deployment Report
        run: |
          echo "## ðŸš€ Staging Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: Contracts L1" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ghcr.io/${{ github.repository }}/contracts-l1:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ==================== éƒ¨ç½²åˆ° Production ====================
  deploy-production:
    name: ðŸŽ¯ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-docker, security-scan]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://contracts-l1.slasolve.com
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      
      - name: ðŸŽ¯ Deploy to Production
        run: |
          echo "ðŸŽ¯ Deploying Contracts L1 to Production..."
          echo "Image: ghcr.io/${{ github.repository }}/contracts-l1:${{ github.sha }}"
          # å¯¦éš›éƒ¨ç½²å‘½ä»¤å°‡æ ¹æ“šæ‚¨çš„åŸºç¤Žè¨­æ–½è€Œå®š
      
      - name: âœ… Verify Deployment
        run: |
          echo "âœ… Verifying production deployment..."
          # å¥åº·æª¢æŸ¥
          # curl -f https://contracts-l1.slasolve.com/healthz || exit 1
      
      - name: ðŸ“Š Create Deployment Report
        run: |
          echo "## ðŸŽ¯ Production Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: Contracts L1" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ghcr.io/${{ github.repository }}/contracts-l1:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“¢ Notify Deployment
        run: |
          echo "ðŸ“¢ Notifying stakeholders..."
          # Slack é€šçŸ¥æˆ–å…¶ä»–é€šçŸ¥æ©Ÿåˆ¶
