name: "Automated Vulnerability Remediation"

on:
  schedule:
    # æ¯å¤©åŸ·è¡Œæ¼æ´žæŽƒæå’Œä¿®å¾©
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      severity_threshold:
        description: 'Minimum severity to fix (low, moderate, high, critical)'
        required: true
        default: 'moderate'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical
      auto_merge:
        description: 'Auto-merge safe updates'
        required: true
        default: true
        type: boolean
      dry_run:
        description: 'Dry run mode (no actual changes)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  security-events: write
  issues: write

jobs:
  vulnerability-assessment:
    runs-on: ubuntu-latest
    outputs:
      has-vulnerabilities: ${{ steps.analyze.outputs.has-vulnerabilities }}
      critical-count: ${{ steps.analyze.outputs.critical-count }}
      high-count: ${{ steps.analyze.outputs.high-count }}
      
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        pip install requests pyyaml
        
    - name: Analyze Vulnerabilities
      id: analyze
      env:
        GH_TOKEN: ${{ github.token }}
        SEVERITY_THRESHOLD: ${{ github.event.inputs.severity_threshold || 'moderate' }}
      run: |
        echo "Analyzing vulnerabilities..."
        
        # Run vulnerability analysis
        python3 scripts/vulnerability-alert-handler.py \
          --org "${{ github.repository_owner }}" \
          --repo "${{ github.event.repository.name }}" \
          --severity-threshold "$SEVERITY_THRESHOLD" \
          --output-format json \
          --output-file vulnerability-analysis.json
        
        # Check if we have vulnerabilities
        if [ -f vulnerability-analysis.json ]; then
          # Count vulnerabilities by category
          CRITICAL=$(jq '.critical_immediate.count // 0' vulnerability-analysis.json)
          HIGH=$(jq '.high_urgent.count // 0' vulnerability-analysis.json)
          TOTAL=$((CRITICAL + HIGH))
          
          echo "critical-count=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high-count=$HIGH" >> $GITHUB_OUTPUT
          
          if [ $TOTAL -gt 0 ]; then
            echo "has-vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "Found $TOTAL vulnerabilities requiring attention"
          else
            echo "has-vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "No vulnerabilities found above threshold"
          fi
        else
          echo "has-vulnerabilities=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload Analysis Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vulnerability-analysis
        path: vulnerability-analysis.json
        retention-days: 30

  enable-dependabot:
    runs-on: ubuntu-latest
    needs: vulnerability-assessment
    if: needs.vulnerability-assessment.outputs.has-vulnerabilities == 'true'
    
    steps:
    - name: Enable Dependabot Alerts
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Ensuring Dependabot is enabled..."
        
        # Enable Dependabot security updates
        gh api --method PATCH \
          /repos/${{ github.repository }} \
          -f "security_and_analysis[dependabot_security_updates][status]=enabled" || true

  create-remediation-prs:
    runs-on: ubuntu-latest
    needs: [vulnerability-assessment, enable-dependabot]
    if: needs.vulnerability-assessment.outputs.has-vulnerabilities == 'true'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Download Analysis Results
      uses: actions/download-artifact@v4
      with:
        name: vulnerability-analysis
    
    - name: Trigger Dependabot Updates
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Triggering Dependabot security updates..."
        
        # Get list of vulnerable dependencies
        gh api /repos/${{ github.repository }}/dependabot/alerts \
          --jq '.[] | select(.state == "open") | .dependency.package.name' \
          > vulnerable-packages.txt
        
        if [ -s vulnerable-packages.txt ]; then
          echo "Found vulnerable packages:"
          cat vulnerable-packages.txt
          
          # Note: Dependabot will automatically create PRs for these
          echo "Dependabot will automatically create PRs for security updates"
        else
          echo "No vulnerable packages found"
        fi
    
    - name: Create Tracking Issue
      if: ${{ needs.vulnerability-assessment.outputs.critical-count > 0 }}
      uses: actions/github-script@v7
      with:
        script: |
          const criticalCount = ${{ needs.vulnerability-assessment.outputs.critical-count }};
          const highCount = ${{ needs.vulnerability-assessment.outputs.high-count }};
          
          const issueBody = `## ðŸ” Security Vulnerability Alert
          
          ### Summary
          - **Critical**: ${criticalCount}
          - **High**: ${highCount}
          
          ### Automated Actions Taken
          - âœ… Vulnerability assessment completed
          - âœ… Dependabot security updates enabled
          - â³ Waiting for Dependabot to create PRs
          
          ### Next Steps
          1. Review Dependabot PRs when they are created
          2. Test and merge security updates
          3. Monitor for any breaking changes
          
          ### SLA Targets
          - **Critical**: 4 hours
          - **High**: 24 hours
          
          This issue will be automatically closed when all security PRs are merged.
          
          ---
          Generated by [Automated Vulnerability Remediation Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          const { data: issue } = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `[Security] ${criticalCount} Critical Vulnerabilities Detected`,
            body: issueBody,
            labels: ['security', 'vulnerability', 'automated']
          });
          
          console.log(`Created tracking issue: ${issue.html_url}`);

  auto-merge-safe-updates:
    runs-on: ubuntu-latest
    needs: create-remediation-prs
    if: github.event.inputs.auto_merge == 'true' && github.event.inputs.dry_run != 'true'
    
    steps:
    - name: Enable Auto-merge for Dependabot PRs
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Configuring auto-merge for safe Dependabot PRs..."
        
        # Get all open Dependabot PRs
        gh pr list \
          --repo ${{ github.repository }} \
          --author "app/dependabot" \
          --state open \
          --json number,title \
          --jq '.[] | .number' > dependabot-prs.txt
        
        if [ ! -s dependabot-prs.txt ]; then
          echo "No Dependabot PRs found"
          exit 0
        fi
        
        while read -r pr_number; do
          echo "Processing PR #$pr_number..."
          
          # Get PR details
          PR_TITLE=$(gh pr view $pr_number --json title --jq '.title')
          
          # Only auto-merge patch and minor updates
          if echo "$PR_TITLE" | grep -iE "patch|minor"; then
            echo "Enabling auto-merge for safe update PR #$pr_number"
            gh pr merge $pr_number --auto --squash || true
          else
            echo "Skipping auto-merge for PR #$pr_number (major update)"
          fi
        done < dependabot-prs.txt

  generate-report:
    runs-on: ubuntu-latest
    needs: [vulnerability-assessment, create-remediation-prs]
    if: always()
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: pip install requests pyyaml
    
    - name: Generate Security Report
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Generating security report..."
        
        python3 scripts/vulnerability-alert-handler.py \
          --org "${{ github.repository_owner }}" \
          --repo "${{ github.event.repository.name }}" \
          --severity-threshold "low" \
          --output-format markdown \
          --output-file security-report.md
        
        echo "Report generated successfully"
    
    - name: Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md
        retention-days: 90
    
    - name: Post Summary
      run: |
        echo "## ðŸ” Vulnerability Remediation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Severity Threshold**: ${{ github.event.inputs.severity_threshold || 'moderate' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Auto-merge Enabled**: ${{ github.event.inputs.auto_merge || 'true' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Dry Run**: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
        echo "- **Critical**: ${{ needs.vulnerability-assessment.outputs.critical-count || '0' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **High**: ${{ needs.vulnerability-assessment.outputs.high-count || '0' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Actions Taken" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Vulnerability assessment completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependabot enabled for security updates" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.vulnerability-assessment.outputs.has-vulnerabilities }}" == "true" ]; then
          echo "- âœ… Tracking issue created" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
