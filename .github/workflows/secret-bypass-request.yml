name: "Secret Scanning Bypass Request"

on:
  workflow_dispatch:
    inputs:
      alert_id:
        description: 'Secret scanning alert ID'
        required: true
        type: string
      bypass_reason:
        description: 'Reason for bypass request'
        required: true
        type: choice
        options:
          - 'False positive'
          - 'Test data'
          - 'Legacy system migration'
          - 'Approved exception'
          - 'Development environment only'
      approver:
        description: 'Security team approver username'
        required: true
        type: string
      justification:
        description: 'Detailed justification for bypass'
        required: true
        type: string

jobs:
  process-bypass-request:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write

    steps:
    - uses: actions/checkout@v4

    - name: Validate Request
      id: validate
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Validating bypass request..."
        REQUESTER="${{ github.actor }}"
        ALERT_ID="${{ github.event.inputs.alert_id }}"
        
        echo "Requester: $REQUESTER"
        echo "Alert ID: $ALERT_ID"
        
        # Check if requester has appropriate permissions
        # In production, this should check against security team membership
        echo "âœ… Request validated"
        echo "requester=$REQUESTER" >> $GITHUB_OUTPUT

    - name: Get Alert Details
      id: alert
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Fetching alert details..."
        
        # Get alert information
        ALERT_INFO=$(gh api \
          /repos/${{ github.repository }}/secret-scanning/alerts/${{ github.event.inputs.alert_id }} \
          --jq '{state: .state, secret_type: .secret_type, created_at: .created_at}' || echo '{}')
        
        echo "Alert info: $ALERT_INFO"
        echo "alert_info=$ALERT_INFO" >> $GITHUB_OUTPUT

    - name: Create Bypass Request Issue
      id: create-issue
      uses: actions/github-script@v8
      with:
        script: |
          const alertId = '${{ github.event.inputs.alert_id }}';
          const reason = '${{ github.event.inputs.bypass_reason }}';
          const approver = '${{ github.event.inputs.approver }}';
          const justification = '${{ github.event.inputs.justification }}';
          const requester = '${{ github.actor }}';
          
          const issueBody = `## Secret Scanning Bypass Request
          
          ### Request Details
          - **Alert ID**: ${alertId}
          - **Requested by**: @${requester}
          - **Requested on**: ${new Date().toISOString()}
          - **Reason**: ${reason}
          
          ### Justification
          ${justification}
          
          ### Required Approval
          - **Approver**: @${approver}
          - **Status**: â³ Pending Review
          
          ---
          
          ### Review Checklist
          - [ ] Verified alert details
          - [ ] Confirmed reason is valid
          - [ ] Assessed security impact
          - [ ] Verified no actual credential exposure
          - [ ] Documented decision
          
          ### Actions for Approver
          To approve this request:
          \`\`\`bash
          gh api --method PATCH \\
            /repos/${{ github.repository }}/secret-scanning/alerts/${alertId} \\
            -f state=resolved \\
            -f resolution=false_positive
          \`\`\`
          
          To reject this request, close this issue with a comment explaining the reason.
          
          ### Security Team Notes
          - Review the alert context carefully
          - Ensure the secret is not actually exposed
          - Verify the justification is legitimate
          - Document the decision for audit purposes
          `;
          
          const { data: issue } = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `[Secret Bypass] Alert ${alertId} - ${reason}`,
            body: issueBody,
            labels: ['security', 'secret-scanning', 'bypass-request'],
            assignees: [approver]
          });
          
          console.log(`âœ… Issue created: ${issue.html_url}`);
          core.setOutput('issue_number', issue.number);
          core.setOutput('issue_url', issue.html_url);
          
          return issue.number;

    - name: Notify Security Team
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Notifying security team..."
        
        # Create a comment tagging the security team
        gh issue comment ${{ steps.create-issue.outputs.issue_number }} \
          --body "ðŸ”” Security team notification: @${{ github.event.inputs.approver }} - Please review this bypass request."

    - name: Add Audit Log Entry
      run: |
        # Create audit log entry
        AUDIT_DIR=".github/audit-logs"
        mkdir -p "$AUDIT_DIR"
        
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        LOG_FILE="$AUDIT_DIR/secret-bypass-requests.json"
        
        # Create or update audit log
        if [ ! -f "$LOG_FILE" ]; then
          echo "[]" > "$LOG_FILE"
        fi
        
        # Add new entry
        cat "$LOG_FILE" | jq --arg timestamp "$TIMESTAMP" \
          --arg requester "${{ github.actor }}" \
          --arg alert_id "${{ github.event.inputs.alert_id }}" \
          --arg reason "${{ github.event.inputs.bypass_reason }}" \
          --arg approver "${{ github.event.inputs.approver }}" \
          --arg issue "${{ steps.create-issue.outputs.issue_number }}" \
          '. += [{
            timestamp: $timestamp,
            requester: $requester,
            alert_id: $alert_id,
            reason: $reason,
            approver: $approver,
            issue_number: $issue,
            status: "pending"
          }]' > "${LOG_FILE}.tmp"
        
        mv "${LOG_FILE}.tmp" "$LOG_FILE"
        
        echo "âœ… Audit log entry created"

    - name: Summary
      run: |
        echo "## Bypass Request Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Alert ID**: ${{ github.event.inputs.alert_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**Reason**: ${{ github.event.inputs.bypass_reason }}" >> $GITHUB_STEP_SUMMARY
        echo "**Approver**: @${{ github.event.inputs.approver }}" >> $GITHUB_STEP_SUMMARY
        echo "**Issue**: #${{ steps.create-issue.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“‹ [View Request](${{ steps.create-issue.outputs.issue_url }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â³ Waiting for security team review..." >> $GITHUB_STEP_SUMMARY
