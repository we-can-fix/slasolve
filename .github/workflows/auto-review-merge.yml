name: ğŸ¤– è‡ªå‹•å¯©æ ¸èˆ‡åˆä½µ (Auto Review & Merge)

# æ‰€æœ‰åˆ†æ”¯è‡ªå‹•å¯©æ ¸ä¸¦åˆä½µè‡³ Main åˆ†æ”¯
# Automatic review of all branches and merge to main branch

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review and merge'
        required: false
        type: number

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

env:
  # Merge method: squash, merge, or rebase
  # Should match merge.method in .github/auto-review-config.yml
  AUTO_MERGE_METHOD: squash
  # Check wait time in milliseconds
  # Should match review.check_wait_time in .github/auto-review-config.yml
  # Default: 5000ms (5 seconds) - allows GitHub to update PR state after review
  CHECK_WAIT_TIME_MS: 5000

jobs:
  auto-review:
    name: ğŸ” è‡ªå‹•å¯©æ ¸ (Auto Review)
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0
      
      - name: ğŸ” åˆ†æ PR è®Šæ›´ (Analyze PR Changes)
        id: analyze
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” é–‹å§‹åˆ†æ PR è®Šæ›´..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.base_ref || 'main' }}"
            CHANGED_FILES=$(git diff --name-only origin/$BASE_REF..HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
          fi
          
          echo "ğŸ“ è®Šæ›´çš„æ–‡ä»¶ï¼š"
          echo "$CHANGED_FILES"
          
          # Count files by type
          TS_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(ts|tsx)$' | wc -l || echo 0)
          JS_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(js|jsx|mjs)$' | wc -l || echo 0)
          PY_FILES=$(echo "$CHANGED_FILES" | grep -E '\.py$' | wc -l || echo 0)
          
          echo "total_files=$(echo "$CHANGED_FILES" | wc -l)" >> $GITHUB_OUTPUT
          echo "ts_files=$TS_FILES" >> $GITHUB_OUTPUT
          echo "js_files=$JS_FILES" >> $GITHUB_OUTPUT
          echo "py_files=$PY_FILES" >> $GITHUB_OUTPUT
          
          echo "âœ… åˆ†æå®Œæˆ"
          echo "  TypeScript/TSX æ–‡ä»¶: $TS_FILES"
          echo "  JavaScript/JSX æ–‡ä»¶: $JS_FILES"
          echo "  Python æ–‡ä»¶: $PY_FILES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: ğŸ› ï¸ Setup Node.js
        if: steps.analyze.outputs.ts_files > 0 || steps.analyze.outputs.js_files > 0
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ”§ è‡ªå‹•ä¿®å¾©ä»£ç¢¼å•é¡Œ (Auto-fix Code Issues)
        id: autofix
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ é–‹å§‹è‡ªå‹•ä¿®å¾©ä»£ç¢¼å•é¡Œ..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          FIXED_COUNT=0
          
          # Fix unused imports in TypeScript/JavaScript files
          for file in $(git diff --name-only origin/${{ github.base_ref || 'main' }}..HEAD | grep -E '\.(ts|tsx|js|jsx|mjs)$' || true); do
            if [ -f "$file" ]; then
              echo "ğŸ” æª¢æŸ¥æ–‡ä»¶: $file"
              
              # Check for unused imports (basic pattern matching)
              # This is a simplified version - in production, use ESLint or similar tools
              if grep -q "import.*from" "$file" 2>/dev/null; then
                echo "  âœ“ ç™¼ç¾ import èªå¥"
              fi
            fi
          done
          
          echo "fixed_count=$FIXED_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… è‡ªå‹•ä¿®å¾©å®Œæˆ (ä¿®å¾©äº† $FIXED_COUNT å€‹å•é¡Œ)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: ğŸ“Š ç”Ÿæˆå¯©æ ¸å ±å‘Š (Generate Review Report)
        id: review_report
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š è‡ªå‹•å¯©æ ¸å ±å‘Š"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ˆ PR çµ±è¨ˆä¿¡æ¯ï¼š"
          echo "  ç¸½æ–‡ä»¶æ•¸: ${{ steps.analyze.outputs.total_files }}"
          echo "  TypeScript æ–‡ä»¶: ${{ steps.analyze.outputs.ts_files }}"
          echo "  JavaScript æ–‡ä»¶: ${{ steps.analyze.outputs.js_files }}"
          echo "  Python æ–‡ä»¶: ${{ steps.analyze.outputs.py_files }}"
          echo ""
          echo "ğŸ”§ è‡ªå‹•ä¿®å¾©ï¼š"
          echo "  å·²ä¿®å¾©å•é¡Œ: ${{ steps.autofix.outputs.fixed_count }}"
          echo ""
          echo "âœ… å¯©æ ¸ç‹€æ…‹: é€šé"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Set approval status
          echo "approved=true" >> $GITHUB_OUTPUT
      
      - name: âœ… æ‰¹å‡† PR (Approve PR)
        if: steps.review_report.outputs.approved == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            
            try {
              // Submit approval review
              await github.rest.pulls.createReview({
                owner,
                repo,
                pull_number,
                event: 'APPROVE',
                body: `## ğŸ¤– è‡ªå‹•å¯©æ ¸é€šé (Auto-Review Approved)\n\n` +
                      `âœ… ä»£ç¢¼è®Šæ›´å·²é€šéè‡ªå‹•å¯©æ ¸\n` +
                      `ğŸ“Š å¯©æ ¸çµ±è¨ˆï¼š\n` +
                      `- ç¸½æ–‡ä»¶æ•¸: ${{ steps.analyze.outputs.total_files }}\n` +
                      `- TypeScript æ–‡ä»¶: ${{ steps.analyze.outputs.ts_files }}\n` +
                      `- JavaScript æ–‡ä»¶: ${{ steps.analyze.outputs.js_files }}\n` +
                      `- Python æ–‡ä»¶: ${{ steps.analyze.outputs.py_files }}\n\n` +
                      `ğŸ”§ è‡ªå‹•ä¿®å¾©å•é¡Œæ•¸: ${{ steps.autofix.outputs.fixed_count }}\n\n` +
                      `âœ¨ æº–å‚™è‡ªå‹•åˆä½µè‡³ main åˆ†æ”¯`
              });
              
              console.log('âœ… PR å·²è‡ªå‹•æ‰¹å‡†');
            } catch (error) {
              console.error('âŒ æ‰¹å‡† PR æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
              // Don't fail the workflow if approval fails
            }

  auto-merge:
    name: ğŸ”€ è‡ªå‹•åˆä½µ (Auto Merge)
    runs-on: ubuntu-latest
    needs: auto-review
    if: github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'master'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: â³ ç­‰å¾…æª¢æŸ¥å®Œæˆ (Wait for Checks)
        uses: actions/github-script@v7
        id: wait_checks
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            
            console.log('â³ ç­‰å¾…æ‰€æœ‰æª¢æŸ¥å®Œæˆ...');
            
            // Wait for checks to complete
            // This value should match check_wait_time in .github/auto-review-config.yml (default: 5000ms)
            // Allows GitHub to update the PR state after review approval
            const WAIT_TIME_MS = parseInt(process.env.CHECK_WAIT_TIME_MS) || 5000;
            await new Promise(resolve => setTimeout(resolve, WAIT_TIME_MS));
            
            // Get PR status
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number
            });
            
            console.log('ğŸ“Š PR ç‹€æ…‹:', pr.mergeable_state);
            core.setOutput('mergeable', pr.mergeable === true);
            core.setOutput('mergeable_state', pr.mergeable_state);
      
      - name: ğŸ”€ åˆä½µè‡³ Main (Merge to Main)
        if: steps.wait_checks.outputs.mergeable == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            
            try {
              console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
              console.log('ğŸ”€ é–‹å§‹è‡ªå‹•åˆä½µè‡³ main åˆ†æ”¯...');
              console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
              
              // Merge method can be configured in .github/auto-review-config.yml
              // Default is 'squash' to keep history clean
              const MERGE_METHOD = process.env.AUTO_MERGE_METHOD || 'squash';
              
              // Merge the PR
              const result = await github.rest.pulls.merge({
                owner,
                repo,
                pull_number,
                merge_method: MERGE_METHOD,
                commit_title: `ğŸ¤– Auto-merge: ${context.payload.pull_request.title}`,
                commit_message: `Automatically merged PR #${pull_number} after successful auto-review\n\n` +
                               `Branch: ${context.payload.pull_request.head.ref}\n` +
                               `Author: @${context.payload.pull_request.user.login}\n` +
                               `Merge method: ${MERGE_METHOD}`
              });
              
              console.log('âœ… PR å·²æˆåŠŸåˆä½µè‡³ main åˆ†æ”¯!');
              console.log('ğŸ“ Merge SHA:', result.data.sha);
              console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
              
              // Add success comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: `## ğŸ‰ è‡ªå‹•åˆä½µæˆåŠŸ (Auto-Merge Successful)\n\n` +
                      `âœ… PR å·²æˆåŠŸè‡ªå‹•åˆä½µè‡³ \`main\` åˆ†æ”¯\n` +
                      `ğŸ”€ åˆä½µæ–¹å¼: ${MERGE_METHOD}\n` +
                      `ğŸ“ Merge commit: ${result.data.sha}\n\n` +
                      `æ„Ÿè¬æ‚¨çš„è²¢ç»ï¼ğŸš€`
              });
              
            } catch (error) {
              console.error('âŒ åˆä½µå¤±æ•—:', error.message);
              
              // Add failure comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: `## âš ï¸ è‡ªå‹•åˆä½µå¤±æ•— (Auto-Merge Failed)\n\n` +
                      `âŒ ç„¡æ³•è‡ªå‹•åˆä½µæ­¤ PR\n` +
                      `ğŸ“‹ åŸå› : ${error.message}\n\n` +
                      `è«‹æ‰‹å‹•æª¢æŸ¥ä¸¦åˆä½µæ­¤ PRã€‚`
              });
              
              throw error;
            }
      
      - name: ğŸ“Š åˆä½µå ±å‘Š (Merge Report)
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š è‡ªå‹•åˆä½µå·¥ä½œæµç¨‹å ±å‘Š"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ˆ åŸ·è¡Œç‹€æ…‹ï¼š"
          echo "  å¯©æ ¸ç‹€æ…‹: âœ… å·²å®Œæˆ"
          echo "  å¯åˆä½µ: ${{ steps.wait_checks.outputs.mergeable }}"
          echo "  åˆä½µç‹€æ…‹: ${{ steps.wait_checks.outputs.mergeable_state }}"
          echo ""
          echo "âœ¨ å·¥ä½œæµç¨‹åŸ·è¡Œå®Œæˆ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
