---
name: Auto Review and Merge

"on":
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]

# 可選：如需要處理 draft 變更解除後自動再評估，保留 ready_for_review 事件

jobs:
  auto-review-merge:
    # 僅針對目標分支為 main 的 PR
    if: github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: write        # 允許合併
      pull-requests: write   # 允許新增審核 / 標記
      actions: read
      checks: read
    steps:
      - name: 取得 PR 資訊
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const pr = context.payload.pull_request;
            core.info(`PR #${pr.number} from ${pr.head.ref}`);
            core.info(`Author: ${pr.user.login}`);
            const labelList = pr.labels.map(l => l.name).join(', ');
            core.info(`Labels: ${labelList || '(none)'}`);

      - name: 驗證作者是否為組織成員
        id: membercheck
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const org = context.payload.organization;
            const ORG = process.env.ORG_NAME ||
              (org ? org.login : 'my-org');
            const author = context.payload.pull_request.user.login;
            try {
              await github.rest.orgs.checkMembershipForUser({
                org: ORG,
                username: author
              });
              core.setOutput('member', 'true');
              core.info(`Author ${author} 是組織成員`);
            } catch (e) {
              core.warning(
                `作者 ${author} 非公開成員或查詢失敗`
              );
              core.setOutput('member', 'false');
            }

      - name: 驗證作者是否為協作者 (write 權限) 或組織成員
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const pr = context.payload.pull_request;
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const author = pr.user.login;
            const isMember = steps.membercheck.outputs.member === 'true';
            let isCollaborator = false;
            let permission = '';
            try {
              const permResp = await github.rest.repos.getCollaboratorPermissionLevel({
                owner,
                repo,
                username: author
              });
              permission = permResp.data.permission;
              core.info(`Author ${author} collaborator permission: ${permission}`);
              if (['admin', 'write', 'maintain'].includes(permission)) {
                isCollaborator = true;
              }
            } catch (e) {
              core.warning(`查詢協作者權限失敗: ${e.message}`);
            }
            if (!isMember && !isCollaborator) {
              core.setFailed(`PR 作者 ${author} 不是組織成員或具有 write 權限的協作者，流程終止。`);
            } else {
              core.info(`作者 ${author} 通過成員/協作者驗證。`);
            }
      - name: 取用程式碼以執行基本檢查
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - name: 基本檢查
        run: |
          echo "✅ 程式碼已取出"
          echo "📁 檔案變更："
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | head -20
          echo "✅ 基本檢查完成"

      - name: 自動核准 PR (若為組織成員)
        if: steps.membercheck.outputs.member == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              event: 'APPROVE',
              body: 'Auto-approved: 組織成員且基本檢查通過'
            });
            core.info('已送出自動核准');

      - name: 判斷是否合併
        if: success()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);
            const memberOut = "${{ steps.membercheck.outputs.member }}";
            const isMember = memberOut === 'true';

            if (!isMember) {
              core.info('非組織成員，跳過自動合併');
              return;
            }
            if (!labels.includes('auto-merge')) {
              core.info('缺少 auto-merge 標籤，跳過合併');
              return;
            }

            core.info('符合條件，嘗試合併 PR');
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              merge_method: 'squash'
            });
            core.notice('✅ PR 已自動合併');

    env:
      # 可在 repository 或 org secret 中設定 ORG_NAME，避免硬編碼
      ORG_NAME: ${{ secrets.ORG_NAME }}

# 使用說明：
# 1. 在 Settings > Secrets 新增 ORG_NAME=你的組織名稱 (若無 organization context)。
# 2. 對欲自動合併的 PR 加上標籤 auto-merge。
# 3. 確保分支保護規則允許由 workflow 產生的審核滿足要求 (或降低 required reviewers)。
# 4. 若需更嚴格條件，可新增：檔案變更範圍、commit 簽名檢查、SLSA 驗證等。
