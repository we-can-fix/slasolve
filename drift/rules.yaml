# ==============================================================================
# Drift Detection Rules - 配置與語意變更偵測規則
# ==============================================================================
# 用途: 檢測配置/契約/映像行為的語意改變
# 語言: 繁體中文
# ==============================================================================

driftDetection:
  enabled: true
  scan_interval: 15m
  scan_targets:
    - kubernetes_manifests
    - api_contracts
    - image_signatures
    - policy_files
  
  # 差異類型與嚴重度
  rules:
    # 資源配置差異
    - id: resource-config-drift
      name: 資源配置差異
      description: 檢測實際部署與 Git 配置的差異
      severity: medium
      type: configuration
      enabled: true
      targets:
        - kind: Deployment
        - kind: Service
        - kind: ConfigMap
      checks:
        - field: spec.replicas
          action: alert
          severity: low
        - field: spec.template.spec.containers[*].image
          action: block
          severity: critical
        - field: spec.template.spec.containers[*].resources
          action: alert
          severity: medium
      remediation:
        auto_fix: false
        action: create_pr
        notification: true
    
    # API 契約差異
    - id: api-contract-drift
      name: API 契約語意變更
      description: 檢測 API schema 與回應格式的語意變更
      severity: high
      type: contract
      enabled: true
      checks:
        - check_type: schema_compatibility
          breaking_changes:
            - removed_field
            - changed_type
            - removed_endpoint
          action: block
          severity: critical
        - check_type: response_shape
          validation: strict
          action: alert
          severity: medium
        - check_type: error_codes
          validation: permissive
          action: warn
          severity: low
      remediation:
        auto_fix: false
        action: notify_owner
        require_approval: true
    
    # 映像行為差異
    - id: image-behavior-drift
      name: 映像行為變更
      description: 檢測映像運行時行為的改變
      severity: high
      type: image
      enabled: true
      checks:
        - check_type: sha256_digest
          validation: strict
          action: block
          severity: critical
        - check_type: sbom_diff
          validation: compare
          action: alert
          severity: medium
        - check_type: vulnerabilities
          scan_on_drift: true
          action: alert
          severity: high
      remediation:
        auto_fix: false
        action: security_review
        notification: true
    
    # 策略檔案差異
    - id: policy-file-drift
      name: 策略檔案變更
      description: 檢測 OPA/Gatekeeper 策略的改變
      severity: critical
      type: policy
      enabled: true
      checks:
        - check_type: syntax_validation
          action: block
          severity: critical
        - check_type: policy_impact
          simulation_required: true
          action: alert
          severity: high
        - check_type: policy_coverage
          validation: increase_only
          action: warn
          severity: medium
      remediation:
        auto_fix: false
        action: policy_review
        require_approval: true
    
    # 標籤差異
    - id: label-drift
      name: 資源標籤差異
      description: 檢測必要標籤的缺失或變更
      severity: medium
      type: labels
      enabled: true
      required_labels:
        - namespace.io/managed-by
        - namespace.io/domain
        - namespace.io/environment
        - app
        - version
      checks:
        - check_type: required_labels
          action: alert
          severity: medium
        - check_type: label_format
          action: warn
          severity: low
      remediation:
        auto_fix: true
        action: apply_labels
        notification: false
    
    # 安全上下文差異
    - id: security-context-drift
      name: 安全上下文變更
      description: 檢測 securityContext 的弱化
      severity: critical
      type: security
      enabled: true
      checks:
        - field: runAsNonRoot
          expected: true
          action: block
          severity: critical
        - field: readOnlyRootFilesystem
          expected: true
          action: alert
          severity: high
        - field: allowPrivilegeEscalation
          expected: false
          action: block
          severity: critical
      remediation:
        auto_fix: false
        action: security_review
        notification: true
  
  # 通知設定
  notifications:
    enabled: true
    channels:
      - type: slack
        webhook_url_secret: slack-webhook
        channels:
          - name: "#platform-alerts"
            severity_filter: ["critical", "high"]
          - name: "#drift-monitoring"
            severity_filter: ["medium", "low"]
      
      - type: email
        recipients:
          - platform-team@example.com
        severity_filter: ["critical"]
      
      - type: pagerduty
        integration_key_secret: pagerduty-key
        severity_filter: ["critical"]
  
  # 報告設定
  reporting:
    enabled: true
    format: json
    retention_days: 90
    storage:
      type: artifact
      path: drift-reports/
    
    summary:
      enabled: true
      interval: daily
      recipients:
        - platform-team@example.com
  
  # 自動修復設定
  auto_remediation:
    enabled: true
    dry_run: false
    allowed_fixes:
      - label-drift
    
    approval_required:
      - resource-config-drift
      - policy-file-drift
      - security-context-drift
    
    max_auto_fixes_per_hour: 10

# ==============================================================================
# 使用說明
# ==============================================================================
# 1. 部署 drift detector:
#    kubectl apply -f drift/scan-cronjob.yaml
#
# 2. 手動觸發掃描:
#    kubectl create job drift-scan-manual --from=cronjob/drift-detector
#
# 3. 查看 drift 報告:
#    kubectl logs -l app=drift-detector
#
# 4. 配置規則:
#    編輯此檔案並重新應用 ConfigMap
# ==============================================================================
